<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯¾ç¨‹è¡¨</title>
    <!-- æ·»åŠ  Firebase SDK (ä½¿ç”¨CDNæ–¹å¼ï¼Œé€‚åˆGitHub Pages) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary-color: #3498db; --secondary-color: #2ecc71; --danger-color: #e74c3c;
            --light-gray: #f4f7fa; --medium-gray: #e0e0e0; --dark-gray: #333;
            --text-color: #333; --bg-color: #fff;
            --header-bg: #f2f2f2;
            --highlight-bg: #dcf4ff;
            --dim-opacity: 0.4;
            --today-bg: #fff2f2;
            
            /* ç”¨æˆ·é¢œè‰² */
            --user-chloe: #3498db;     /* è“è‰² */
            --user-charlene: #f1c40f;  /* é»„è‰² */
            --user-yeung: #2c3e50;     /* é»‘è‰² */
            
            /* å­¦ç”Ÿé¢œè‰² - æ”¹ä¸ºè“è‰²ç³»åˆ— */
            --student-color: #3498db;  /* è“è‰² */
        }
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden; 
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background-color: var(--light-gray); 
            color: var(--text-color); 
            padding: 10px;
            box-sizing: border-box;
        }
        .app-container { 
            width: 100%;
            height: 100%;
            max-width: 1800px; 
            margin: 0 auto; 
            background-color: var(--bg-color); 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }
        
        .control-panel { 
            padding: 15px 25px; 
            border-bottom: 1px solid var(--medium-gray); 
            background-color: #fdfdfd; 
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
        }
        .control-panel h2 { margin: 0; font-size: 1.2em; }
        .view-switcher { margin-left: 20px; display: flex; gap: 5px; border: 1px solid #ccc; border-radius: 5px; padding: 2px; }
        .view-switcher button { background: transparent; border: none; padding: 6px 12px; cursor: pointer; border-radius: 4px; font-size: 0.9em; }
        .view-switcher button.active { background-color: var(--primary-color); color: white; }
        .main-content-switcher {
    margin-left: 25px;
    display: flex;
    gap: 5px;
    border: 1px solid #ccc;
    border-radius: 5px;
    padding: 2px;
}
.main-content-switcher button {
    background: transparent;
    border: none;
    padding: 6px 12px;
    cursor: pointer;
    border-radius: 4px;
    font-size: 0.9em;
}
.main-content-switcher button.active {
    background-color: var(--primary-color);
    color: white;
}
        .control-panel .spacer { flex-grow: 1; }
        #error-message { color: var(--danger-color); height: 1em; margin: 0; padding: 0 10px; }

        /* è§†å›¾æ¨¡å¼åˆ‡æ¢ */
        .view-mode-selector {
            display: flex;
            gap: 10px;
            margin-left: 20px;
        }
        
        .view-mode-selector label {
            display: flex;
            align-items: center;
            font-size: 0.85em;
            cursor: pointer;
        }
        
        .view-mode-selector input {
            margin-right: 5px;
        }

        .filters-container { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; padding: 15px 25px; border-bottom: 1px solid var(--medium-gray); background-color: #f9fafb; flex-shrink: 0; }
        .filters-container select, .filters-container input[type="date"] { padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; }
        .filters-container .date-filter-label { font-size: 0.9em; color: #555; }
        #reset-filters-button { padding: 8px 16px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; cursor: pointer; }

        .view-container { flex-grow: 1; overflow: auto; position: relative; }
        .view { display: none; }
        .view.active { display: flex; flex-direction: column; height: 100%; }

        /* --- ç”˜ç‰¹å›¾æ ·å¼ --- */
        #gantt-view.active { display: flex; flex-direction: row; }
        .gantt-chart { display: flex; align-items: flex-start; width: 100%; height: 100%; }
        .gantt-tasks { flex-shrink: 0; width: 260px; border-right: 1px solid var(--medium-gray); background: #fdfdfd; position: sticky; left: 0; z-index: 20; }
        .gantt-task-header { height: 80px; display: flex; align-items: center; justify-content: center; padding: 10px; border-bottom: 1px solid var(--medium-gray); font-weight: bold; box-sizing: border-box; position: sticky; top: 0; background: #fdfdfd; z-index: 21; }
        .gantt-task-group-header, .gantt-task-item, .gantt-row { transition: opacity 0.2s ease-in-out, background-color 0.2s ease-in-out; }
        .gantt-task-group-header { height: 50px; padding: 0 15px; display: flex; align-items: center; border-bottom: 1px solid var(--medium-gray); font-weight: 600; background-color: var(--header-bg); box-sizing: border-box; cursor: pointer; }
        .gantt-task-group-header .toggle-icon { margin-right: 8px; font-family: monospace; transition: transform 0.2s; display: inline-block; }
        .gantt-task-group-header.collapsed .toggle-icon { transform: rotate(-90deg); }
        .gantt-task-item { height: 50px; padding: 0 15px 0 30px; display: flex; flex-direction: column; justify-content: center; border-bottom: 1px solid #f0f0f0; box-sizing: border-box; overflow: hidden; }
        .task-topic { font-weight: 500; font-size: 0.9em; }
        .task-session { font-size: 0.8em; color: #666; }
        .gantt-grid { position: relative; display: flex; flex-direction: column; flex-grow: 1; }
        .gantt-timeline { position: sticky; top: 0; z-index: 10; background: var(--bg-color); }
        .gantt-months, .gantt-days { display: flex; }
        
        /* ä¿®æ”¹æ—¥æœŸå•å…ƒæ ¼æ ·å¼ï¼Œå¢å¼ºè¾¹æ¡† */
        .gantt-month { 
            height: 40px; 
            font-size: 0.8em; 
            flex-shrink: 0; 
            box-sizing: border-box; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-right: 1px solid var(--medium-gray); 
            border-bottom: 1px solid var(--medium-gray); 
            font-weight: bold; 
        }
        
        .gantt-day { 
            height: 40px; 
            width: 40px; 
            font-size: 0.75em; 
            flex-shrink: 0; 
            box-sizing: border-box; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-right: 1px solid var(--medium-gray); 
            border-bottom: 1px solid var(--medium-gray); 
            font-weight: bold; 
            position: relative;
            background-color: #fdfdfd;
        }
        
        /* æ·»åŠ å·¦è¾¹æ¡†ç»™ç¬¬ä¸€ä¸ªæ—¥æœŸå•å…ƒæ ¼ */
        .gantt-days .gantt-day:first-child {
            border-left: 1px solid var(--medium-gray);
        }
        
        /* ç”˜ç‰¹å›¾è¡ŒåŒºåŸŸæ˜¾ç¤ºç½‘æ ¼èƒŒæ™¯ */
        .gantt-rows { 
            position: relative;
            background-color: white;
            background-image: 
                linear-gradient(to right, var(--medium-gray) 1px, transparent 1px);
            background-size: 40px 100%;
            background-position: 0 0;
        }
        
        /* ä¿®æ”¹æŠ˜å æ ·å¼ï¼Œæ”¹ä¸ºå®Œå…¨ä¸å ç”¨ç©ºé—´ */
        .gantt-row { 
            height: 50px; 
            box-sizing: border-box; 
            border-bottom: 1px solid #f0f0f0; 
            overflow: hidden;
            position: relative;
            background: transparent; /* æ”¹ä¸ºé€æ˜èƒŒæ™¯ä»¥æ˜¾ç¤ºç½‘æ ¼çº¿ */
        }
        
        .gantt-row.group-header-row { 
            background-color: var(--header-bg); 
            border-bottom: 1px solid var(--medium-gray); 
        }
        
        /* é‡è¦ï¼šä½¿ç”¨display:noneå®Œå…¨ç§»å‡ºå¸ƒå±€æµ */
        .gantt-row.collapsed, 
        .gantt-task-item.collapsed,
        .gantt-bar.collapsed { 
            display: none !important;
        }

        /* æ”¹è¿›ç½‘æ ¼çº¿æ ·å¼ï¼Œæé«˜å¯è§æ€§ */
        .gantt-grid-lines { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 0; 
            pointer-events: none; 
        }
        
        .gantt-grid-line { 
            position: absolute; 
            top: 0; 
            bottom: 0; 
            width: 0; /* ç¡®ä¿çº¿æ¡å®½åº¦ä¸º0ï¼Œåªæ˜¾ç¤ºè¾¹æ¡† */
            border-left: 1px dashed var(--medium-gray); 
            z-index: 1;
            opacity: 1; /* ç¡®ä¿ä¸é€æ˜ */
            pointer-events: none;
        }
        
        .gantt-bar { 
            box-sizing: border-box; 
            position: absolute; 
            border-radius: 4px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 0 10px; 
            color: white; 
            font-size: 0.8em; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            cursor: pointer; 
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, z-index 0s 0.2s; 
        }
        .gantt-task-item.highlight, .gantt-row.highlight, .gantt-task-group-header.highlight { background-color: var(--highlight-bg) !important; }
        
        .gantt-chart.is-hovering .gantt-bar:not(.is-hovered) { opacity: var(--dim-opacity) !important; }
        
        .gantt-bar-course { height: 30px; top: 10px; opacity: 0.3; z-index: 1; border: 1px solid rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; padding: 0 5px; }
        .gantt-bar-course-label { font-size: 0.7em; color: #444; font-weight: 600; }
        .gantt-bar-course-text { font-weight: bold; font-size: 0.8em; transition: opacity 0.2s ease-in-out; opacity: 0; color: var(--dark-gray); }

        .gantt-bar-session { height: 22px; top: 14px; z-index: 2; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .gantt-bar-session::before { content: ''; position: absolute; top: -14px; bottom: -14px; left: 0; right: 0; background: transparent; z-index: 1; }

        .gantt-bar-session.is-hovered { transform: scale(1.05); z-index: 16; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); }

        .gantt-bar-course.is-hovered {
            opacity: 0.9 !important;
            transform: scale(1.02);
            z-index: 17;
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, z-index 0s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .gantt-bar-course.is-hovered .gantt-bar-course-text { opacity: 1; }
        
        /* å­¦ç”Ÿå­¦ä¹ æ—¶é—´æ ·å¼ - ä¿®æ”¹ä¸ºè“è‰² */
        .gantt-bar-student {
            height: 16px;
            top: 18px;
            z-index: 3;
            background-color: var(--student-color);
            background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,255,255,0.1) 5px, rgba(255,255,255,0) 5px, rgba(255,255,255,0) 10px);
            border: 1px solid rgba(0,0,0,0.2);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .gantt-bar-student.completed {
            background-image: none;
            background-color: #2980b9; /* æ·±è“è‰²è¡¨ç¤ºå®Œæˆ */
        }
        
        .gantt-bar-student.is-hovered { 
            transform: scale(1.05); 
            z-index: 18; 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        /* å­¦ç”Ÿå­¦ä¹ æ—¶é—´æ—¥å†æ ‡è®° - ä¿®æ”¹ä¸ºè“è‰² */
        .calendar-marker.student-marker {
            background-color: var(--student-color);
            border-radius: 12px;
            font-style: italic;
        }
        
        .calendar-marker.student-marker.completed {
            background-color: #2980b9; /* æ·±è“è‰²è¡¨ç¤ºå®Œæˆ */
        }
        
        .gantt-today-line { 
            position: absolute; 
            top: 0; 
            bottom: 0; 
            width: 2px; 
            background-color: var(--danger-color); 
            z-index: 5; 
            display: none; 
        }
        
        /* å¢å¼ºä»Šæ—¥çº¿æ ·å¼ */
        .gantt-today-line::after {
            content: 'ä»Šå¤©';
            position: absolute;
            top: 5px;
            left: -15px;
            background-color: var(--danger-color);
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.75em;
            white-space: nowrap;
        }

        /* --- æ—¥å†è§†å›¾æ ·å¼ --- */
        #calendar-view { flex-direction: column; padding: 15px 25px; box-sizing: border-box; }
        .calendar-header { display: flex; align-items: center; justify-content: center; margin-bottom: 15px; position: relative; min-height: 70px; }
        .calendar-header h3 { margin: 0; font-size: 1.5em; }
        .calendar-nav { position: absolute; left: 0; display: flex; gap: 10px; }
        .calendar-nav button { padding: 6px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; cursor: pointer; }
        .calendar-grid-container { flex-grow: 1; display: grid; grid-template-rows: auto 1fr; }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: bold; color: #666; padding-bottom: 10px; border-bottom: 1px solid var(--medium-gray); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); grid-auto-rows: minmax(140px, auto); border-left: 1px solid var(--medium-gray); }
        .calendar-day { border-right: 1px solid var(--medium-gray); border-bottom: 1px solid var(--medium-gray); padding: 5px; overflow-y: auto; position: relative; }
        .calendar-day.other-month .day-number { color: #ccc; }
        .calendar-day.today { background-color: var(--today-bg); }
        .day-number { font-weight: 500; margin-bottom: 5px; }
        .calendar-day.today .day-number { color: var(--danger-color); font-weight: bold; }
        .calendar-marker {
            font-size: 0.8em;
            padding: 6px 8px; /* ç¨å¾®å¢å¤§å†…è¾¹è·æå‡å¯è¯»æ€§ /
            border-radius: 6px; / åœ†è§’ç•¥å¤§ /
            margin-bottom: 6px; / æ¯æ¡ä¹‹é—´ç•™äº›è·ç¦» /
            color: white;
            white-space: normal; / å…è®¸æ¢è¡Œ /
            overflow: visible; / ä¸æˆªæ–­ /
            word-break: break-word; / é•¿è¯ä¹Ÿå¯æ¢è¡Œ /
            cursor: pointer;
            display: block; / å æ•´è¡Œï¼Œä¾¿äºå †å  */
        }
        .marker-start { background-color: #27ae60; }
        .marker-end { background-color: #c0392b; }
        .marker-single-day { background-color: #3498db; }
        
        /* ä¿¡æ¯è€å¸ˆä¸“ç”¨é¢œè‰²æ ·å¼ - ä¿®æ”¹ä¸ºç´«è‰²ç³»åˆ— */
        .calendar-marker.marker-info-teacher {
            background-color: #9b59b6; /* ä¸­ç­‰ç´«è‰² */
            color: white;
        }
        
        .calendar-marker.marker-info-start {
            background-color: #6c3483; /* æ·±ç´«è‰² */
            color: white;
        }
        
        .calendar-marker.marker-info-end {
            background-color: #c39bd3; /* æµ…ç´«è‰² */
            color: #333; /* æ·±è‰²æ–‡å­—ï¼Œæé«˜å¯è¯»æ€§ */
        }

        /* å¤šç”¨æˆ·é€‰æ‹©å™¨å’Œä»»åŠ¡æ£€æŸ¥æ ·å¼ */
        .user-selector {
            position: fixed;
            top: 75px; 
            right: 20px;
            background: white;
            padding: 8px;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 0.8em; /* æ›´å°çš„å­—ä½“ */
            max-width: 200px;
        }
        
        .user-option {
            display: flex;
            align-items: center;
            margin-bottom: 3px;
        }
        
        .user-color {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
        }
        
        .user-selector-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.85em;
        }
        
        .user-selector-legend {
            margin-top: 5px;
            font-size: 0.75em;
            color: #666;
        }
        
        .user-chloe { background-color: var(--user-chloe); }
        .user-charlene { background-color: var(--user-charlene); }
        .user-yeung { background-color: var(--user-yeung); }
        
        /* ä»»åŠ¡å¤é€‰æ¡†æ ·å¼æ”¹è¿› */
        .multi-checkbox {
            display: flex;
            gap: 2px;
            margin-right: 4px;
        }
        
        .checkbox-container {
            width: 14px;
            height: 14px;
            position: relative;
        }
        
        .user-checkbox {
            width: 14px;
            height: 14px;
            cursor: pointer;
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            margin: 0;
            z-index: 2;
        }
        
        .checkbox-display {
            width: 14px;
            height: 14px;
            border: 1px solid #ccc;
            border-radius: 3px;
            background: white;
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            z-index: 1;
        }
        
        .user-checkbox:checked + .checkbox-display.chloe::before {
            content: 'âœ“';
            color: var(--user-chloe);
        }
        
        .user-checkbox:checked + .checkbox-display.charlene::before {
            content: 'âœ“';
            color: var(--user-charlene);
        }
        
        .user-checkbox:checked + .checkbox-display.yeung::before {
            content: 'âœ“';
            color: var(--user-yeung);
        }

        .task-feedback {
            position: absolute;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            z-index: 100;
            top: -5px;
            right: 5px;
        }
        
        .task-feedback.chloe {
            background-color: var(--user-chloe);
        }
        
        .task-feedback.charlene {
            background-color: var(--user-charlene);
            color: black; /* é»„è‰²èƒŒæ™¯é…é»‘è‰²æ–‡å­—æ›´æ˜“è¯» */
        }
        
        .task-feedback.yeung {
            background-color: var(--user-yeung);
        }

        .empty-state { display: flex; justify-content: center; align-items: center; width: 100%; height: 150px; color: #999; }
        .tooltip { position: fixed; background-color: rgba(0, 0, 0, 0.8); color: white; padding: 10px 15px; border-radius: 5px; font-size: 0.9em; z-index: 100; pointer-events: none; opacity: 0; transform: translate(-50%, -100%); transition: opacity 0.1s ease; white-space: nowrap; }
        .tooltip.visible { opacity: 1; }
        .tooltip-row { display: flex; justify-content: space-between; padding: 2px 0; }
        .tooltip-label { font-weight: bold; margin-right: 15px; }
        .tooltip-value { color: #ddd; }
        
        /* æ·»åŠ è¿‡æ¸¡åŠ¨ç”» */
        .fade-out {
            opacity: 0;
            transition: opacity 0.2s ease-out;
        }
        
        .fade-in {
            opacity: 0;
            animation: fadeIn 0.3s ease-in forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* æ·»åŠ é¡µè„šæ ·å¼ */
        .footer {
            text-align: center;
            padding: 10px;
            font-size: 0.8em;
            color: #888;
            border-top: 1px solid var(--medium-gray);
        }

        /* æ–°å¢ï¼šç­›é€‰å™¨æ ‡ç­¾æ ·å¼ */
        .filter-label {
            font-size: 0.85em;
            font-weight: 600;
            color: #555;
            margin-right: 5px;
        }
        
        /* éšè—ç­›é€‰å™¨çš„æ ·å¼ */
        .filters-container .filter-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .filters-container .filter-group.hidden {
            display: none;
        }
        
        /* è¿™æ˜¯ä¸ºæ–°åŠŸèƒ½æ·»åŠ çš„CSSæ ·å¼ */
        .calendar-text-note {
            font-size: 12px;
            color: #555;
            line-height: 1.3;
            margin: 2px 0;
            word-break: break-word;
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="control-panel">
        <h2>è¯¾ç¨‹è¡¨</h2>
        <div class="view-switcher">
            <button id="gantt-view-btn" class="active">ç”˜ç‰¹å›¾</button>
            <button id="calendar-view-btn">æ—¥å†</button>
        </div>
        <!-- æ–°å¢ï¼šæ•™å­¦/å­¦ä¹ æ¨¡å—åˆ‡æ¢ -->
<div class="main-content-switcher">
    <button id="teaching-btn" class="active">Teaching Materials</button>
    <button id="learning-btn">Learning Materials</button>
</div>
        
        <!-- æ·»åŠ è§†å›¾æ¨¡å¼åˆ‡æ¢ -->
        <div class="spacer"></div>
        <p id="error-message">æ­£åœ¨åŠ è½½æ•°æ®...</p>
    </div>
    <div class="filters-container">
        <div class="filter-group" id="teacher-filter-group">
            <span class="filter-label">æ•™å¸ˆ:</span>
            <select id="filter-teacher"></select>
        </div>
        
        <div class="filter-group" id="student-filter-group">
            <span class="filter-label">å­¦ç”Ÿ:</span>
            <select id="filter-student"></select>
        </div>
        
        <span class="filter-label">ä¸»é¢˜:</span>
        <select id="filter-topic"></select>
        
        <span class="filter-label">è¯¾æ—¶:</span>
        <select id="filter-session"></select>
        
        <span class="filter-label">æ—¥æœŸèŒƒå›´:</span>
        <input type="date" id="filter-date-start">
        <span class="date-filter-label">è‡³</span>
        <input type="date" id="filter-date-end">
        <button id="reset-filters-button">é‡ç½®ç­›é€‰</button>
    </div>
    <div class="view-container">
        <div id="gantt-view" class="view active">
            <div class="gantt-chart">
                <div class="gantt-tasks"></div>
                <div class="gantt-grid"></div>
            </div>
        </div>
        <div id="calendar-view" class="view">
            <!-- æ—¥å†è§†å›¾å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
    <div class="footer">
        æ•°æ®æœ€åæ›´æ–°: <span id="last-updated-time"></span> | å½“å‰æ—¶é—´: <span id="current-time"></span>
    </div>
</div>
<div class="tooltip" id="tooltip"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("æ­£åœ¨è¿è¡Œè¯¾ç¨‹è¡¨...");

    // Firebase åˆå§‹åŒ–
    const firebaseConfig = {
        apiKey: "AIzaSyDL5vla4WJlGY51fg3ZTODeqnKRxEMUbNU",
        authDomain: "course-schedule-check.firebaseapp.com",
        databaseURL: "https://course-schedule-check-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "course-schedule-check",
        storageBucket: "course-schedule-check.firebasestorage.app",
        messagingSenderId: "104017045221",
        appId: "1:104017045221:web:bd2cbb7135a23df514d60c",
        measurementId: "G-07S6SE764S"
    };

    // åˆå§‹åŒ– Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    let checkStatus = {};

    // å®šä¹‰ç”¨æˆ·
    const users = [
        { id: 'chloe', name: 'Chloe', color: '#3498db' },  // è“è‰²
        { id: 'charlene', name: 'Charlene', color: '#f1c40f' }, // é»„è‰²
        { id: 'yeung', name: 'Mrs. Yeung', color: '#2c3e50' }  // é»‘è‰²
    ];
    
    // å½“å‰é€‰æ‹©çš„ç”¨æˆ·
    let currentUser = users[0].id;

    // ä» Firebase åŠ è½½æ£€æŸ¥çŠ¶æ€
    database.ref('taskCheckStatus').on('value', (snapshot) => {
        console.log("æ­£åœ¨åŠ è½½æ£€æŸ¥çŠ¶æ€...");
        checkStatus = snapshot.val() || {};
        console.log("å·²ä»FirebaseåŠ è½½çŠ¶æ€:", checkStatus);
        
        // å¦‚æœå½“å‰åœ¨æ—¥å†è§†å›¾ï¼Œé‡æ–°æ¸²æŸ“ä»¥æ›´æ–°å¤é€‰æ¡†çŠ¶æ€
        if (currentView === 'calendar') {
            applyFilters();
        }
    });

    // ä¿å­˜æ£€æŸ¥çŠ¶æ€åˆ° Firebase çš„å‡½æ•°
    function saveMultiUserCheckStatus(taskId, userId, isChecked) {
        console.log("æ­£åœ¨ä¿å­˜çŠ¶æ€:", taskId, userId, isChecked);
        
        const path = `taskCheckStatus/${taskId}/${userId}`;
        
        database.ref(path).set(isChecked)
            .then(() => {
                console.log("çŠ¶æ€æˆåŠŸä¿å­˜åˆ°:", path);
            })
            .catch(error => {
                console.error("ä¿å­˜çŠ¶æ€å¤±è´¥:", error);
                errorMessage.textContent = `ä¿å­˜å¤±è´¥: ${error.message}`;
                setTimeout(() => {
                    errorMessage.textContent = '';
                }, 3000);
            });
    }

    // æ˜¾ç¤ºä¿å­˜åé¦ˆ
    function showFeedback(element, userId) {
        const feedback = document.createElement('div');
        feedback.className = `task-feedback ${userId}`;
        feedback.textContent = 'âœ“ å·²ä¿å­˜';
        element.appendChild(feedback);
        
        setTimeout(() => {
            feedback.remove();
        }, 1500);
    }

    let allTasks = [];       // æ•™å¸ˆè¯¾ç¨‹æ•°æ®
    let students = [];       // å­¦ç”Ÿæ•°æ®
    const topicColors = {};
    const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f1c40f', '#9b59b6', '#1abc9c', '#34495e', '#e67e22', '#e84393', '#0984e3', '#6c5ce7', '#00b894'];
    let dayWidth = 40;
    const collapsedGroups = new Set();
    let currentViewMode = 'all';  // å½“å‰è§†å›¾æ¨¡å¼ï¼šall, teacher-only, student-only
    let currentMainSection = 'teaching'; // æ–°å¢ï¼šteaching æˆ– learning

    let currentView = 'gantt';
    let currentDisplayDate = new Date(); // é»˜è®¤æ˜¾ç¤ºä»Šå¤©

    const errorMessage = document.getElementById('error-message');
    
    const ganttView = document.getElementById('gantt-view');
    const calendarView = document.getElementById('calendar-view');
    const ganttTasksContainer = ganttView.querySelector('.gantt-tasks');
    const ganttGrid = ganttView.querySelector('.gantt-grid');

    const filterTeacher = document.getElementById('filter-teacher');
    const filterStudent = document.getElementById('filter-student');
    const filterTopic = document.getElementById('filter-topic');
    const filterSession = document.getElementById('filter-session');
    const tooltip = document.getElementById('tooltip');

    const filterDateStart = document.getElementById('filter-date-start');
    const filterDateEnd = document.getElementById('filter-date-end');
    const resetFiltersButton = document.getElementById('reset-filters-button');
    
    const ganttViewBtn = document.getElementById('gantt-view-btn');
    const calendarViewBtn = document.getElementById('calendar-view-btn');

    // --- æ–°å¢ï¼šTeaching / Learning æ¨¡å—åˆ‡æ¢æŒ‰é’® ---
const teachingBtn = document.getElementById('teaching-btn');
const learningBtn = document.getElementById('learning-btn');

teachingBtn.addEventListener('click', () => {
    if (currentMainSection === 'teaching') return;
    currentMainSection = 'teaching';
    teachingBtn.classList.add('active');
    learningBtn.classList.remove('active');
    currentViewMode = 'teacher-only';
    applyFilters();
});

learningBtn.addEventListener('click', () => {
    if (currentMainSection === 'learning') return;
    currentMainSection = 'learning';
    learningBtn.classList.add('active');
    teachingBtn.classList.remove('active');
    currentViewMode = 'student-only';
    applyFilters();
});

    const lastUpdatedTimeElement = document.getElementById('last-updated-time');
    const currentTimeElement = document.getElementById('current-time');
    
    // ç­›é€‰å™¨ç»„å…ƒç´ 
    const teacherFilterGroup = document.getElementById('teacher-filter-group');
    const studentFilterGroup = document.getElementById('student-filter-group');
    
    // æ›´æ–°ç­›é€‰å™¨å¯è§æ€§
    function updateFilterVisibility() {
        if (currentViewMode === 'teacher-only') {
            teacherFilterGroup.classList.remove('hidden');
            studentFilterGroup.classList.add('hidden');
        } else if (currentViewMode === 'student-only') {
            teacherFilterGroup.classList.add('hidden');
            studentFilterGroup.classList.remove('hidden');
        } else {
            teacherFilterGroup.classList.remove('hidden');
            studentFilterGroup.classList.remove('hidden');
        }
    }
    
    // æ·»åŠ è§†å›¾æ¨¡å¼é€‰æ‹©ç›‘å¬
document.querySelectorAll('input[name="view-mode"]').forEach(radio => {
  radio.addEventListener('change', function() {
    currentViewMode = this.value;
    updateFilterVisibility();
    applyFilters();
  });
});
    // æ›´æ–°å½“å‰æ—¶é—´æ˜¾ç¤º
    function updateCurrentTime() {
        const now = new Date();
        currentTimeElement.textContent = now.toLocaleString('zh-CN');
        setTimeout(updateCurrentTime, 1000); // æ¯ç§’æ›´æ–°ä¸€æ¬¡
    }
    updateCurrentTime();

    filterTeacher.addEventListener('change', applyFilters);
    filterStudent.addEventListener('change', applyFilters);
    filterTopic.addEventListener('change', applyFilters);
    filterSession.addEventListener('change', applyFilters);
    filterDateStart.addEventListener('change', applyFilters);
    filterDateEnd.addEventListener('change', applyFilters);
    resetFiltersButton.addEventListener('click', () => {
        filterTeacher.value = 'æ‰€æœ‰æ•™å¸ˆ';
        filterStudent.value = 'æ‰€æœ‰å­¦ç”Ÿ';
        filterTopic.value = 'æ‰€æœ‰ä¸»é¢˜';
        filterSession.value = 'æ‰€æœ‰è¯¾æ—¶';
        filterDateStart.value = '';
        filterDateEnd.value = '';
        document.querySelector('input[name="view-mode"][value="all"]').checked = true;
        currentViewMode = 'all';
        updateFilterVisibility();
        currentDisplayDate = new Date(); // é‡ç½®ä¸ºå½“å‰æ—¥æœŸ
        applyFilters();
    });

    ganttViewBtn.addEventListener('click', () => switchView('gantt'));
    calendarViewBtn.addEventListener('click', () => switchView('calendar'));

    function switchView(view) {
        if (currentView === view) return;
        
        const currentViewEl = document.querySelector('.view.active');
        const newViewEl = document.getElementById(`${view}-view`);
        
        // æ·»åŠ è¿‡æ¸¡åŠ¨ç”»
        currentViewEl.classList.add('fade-out');
        
        setTimeout(() => {
            // åˆ‡æ¢è§†å›¾
            currentView = view;
            ganttViewBtn.classList.toggle('active', view === 'gantt');
            calendarViewBtn.classList.toggle('active', view === 'calendar');
            currentViewEl.classList.remove('active', 'fade-out');
            newViewEl.classList.add('active', 'fade-in');
            
            setTimeout(() => {
                newViewEl.classList.remove('fade-in');
                applyFilters();
            }, 300);
        }, 200);
    }
    
    function loadDataAndInitialize() {
        // åŠ è½½æ•™å¸ˆæ•°æ®
        fetch('data.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`æ— æ³•åŠ è½½ data.json (çŠ¶æ€: ${response.status})ã€‚è¯·ç¡®è®¤åå° Excel å·²ä¸Šä¼ ä¸”è‡ªåŠ¨åŒ–æµç¨‹æˆåŠŸè¿è¡Œã€‚`);
                }
                return response.json();
            })
            .then(data => {
                allTasks = data;
                errorMessage.textContent = '';
                
                // å°è¯•åŠ è½½å­¦ç”Ÿæ•°æ®
                return fetch('students.json')
                    .catch(err => {
                        console.warn("æ— æ³•åŠ è½½å­¦ç”Ÿæ•°æ®:", err);
                        return { ok: false }; // å¦‚æœæ²¡æœ‰å­¦ç”Ÿæ•°æ®ï¼Œè¿”å›å¤±è´¥çŠ¶æ€
                    });
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    console.warn("å­¦ç”Ÿæ•°æ®ä¸å­˜åœ¨æˆ–æ— æ³•åŠ è½½ï¼Œä½¿ç”¨ç©ºæ•°ç»„");
                    return [];
                }
            })
            .then(studentData => {
                students = studentData || [];
                console.log("å·²åŠ è½½å­¦ç”Ÿæ•°æ®:", students);
                
                // å¦‚æœæ— æ³•è·å–å­¦ç”Ÿæ•°æ®ï¼Œåˆ›å»ºé»˜è®¤å­¦ç”Ÿ
                if (students.length === 0) {
                    students = [{
                        id: "student_åŒå­¦",
                        name: "åŒå­¦",
                        studySessions: []
                    }];
                    
                    // ä»æ•™å¸ˆæ•°æ®ä¸­æå–è¯¾æ—¶ä¿¡æ¯ï¼Œæ„å»ºé»˜è®¤å­¦ä¹ è®°å½•
                    const courses = {};
                    allTasks.forEach(task => {
                        const key = `${task.topic}_${task.session}`;
                        if (!courses[key] && task.topic && task.session) {
                            courses[key] = {
                                topic: task.topic,
                                session: task.session
                            };
                        }
                    });
                    
                    // æŸ¥çœ‹æ˜¯å¦å¯ä»¥ä»æ•°æ®ä¸­è¯†åˆ«å­¦ä¹ è®°å½•
                    const studySessions = Object.values(courses).map((course, index) => ({
                        id: `study_${index}`,
                        topic: course.topic,
                        session: course.session,
                        startTime: "", // è¿™äº›å¯èƒ½éœ€è¦æ ¹æ®å®é™…æƒ…å†µè®¾ç½®
                        endTime: "",
                        duration: 60,
                        completed: false,
                        notes: ""
                    }));
                    
                    students[0].studySessions = studySessions;
                }

                if (allTasks.length === 0 && students.length === 0) {
                    throw new Error("åŠ è½½çš„æ•°æ®ä¸ºç©ºã€‚è¯·æ£€æŸ¥åå° schedule.xlsx æ–‡ä»¶å†…å®¹æ˜¯å¦æ­£ç¡®ã€‚");
                }
                
                // è®¾ç½®æœ€åæ›´æ–°æ—¶é—´
                lastUpdatedTimeElement.textContent = new Date().toLocaleDateString('zh-CN');
                
                collapsedGroups.clear();
                currentDisplayDate = new Date(); // ä½¿ç”¨å½“å‰æ—¥æœŸ
                updateFilterVisibility(); // åˆå§‹åŒ–ç­›é€‰å™¨å¯è§æ€§
                applyFilters(); // â¬…ï¸ æ”¹æˆç›´æ¥è°ƒç”¨ applyFiltersï¼Œè€Œä¸æ˜¯æ¨¡æ‹Ÿç‚¹å‡»
errorMessage.textContent = '';  // æ¸…ç©ºçŠ¶æ€æç¤º
console.log("âœ… æ•°æ®åŠ è½½å®Œæˆï¼Œé¦–æ¬¡æ¸²æŸ“å·²æ‰§è¡Œ");)
            .catch(err => {
                errorMessage.textContent = 'åŠ è½½æ•°æ®å¤±è´¥: ' + err.message;
                console.error(err);
                renderEmpty();
            });
    }

    // ä¿®æ”¹çš„populateFilterDropdownå‡½æ•°
    function populateFilterDropdown(selectElement, options, currentlySelected, defaultOption = null) {
        // ç¡®ä¿é»˜è®¤é€‰é¡¹ï¼ˆå¦‚'æ‰€æœ‰æ•™å¸ˆ'ï¼‰å§‹ç»ˆåœ¨ç¬¬ä¸€ä½
        if (defaultOption) {
            // å…ˆç§»é™¤é»˜è®¤é€‰é¡¹ï¼Œä»¥é˜²å®ƒä¹Ÿåœ¨optionsä¸­
            const filteredOptions = options.filter(option => option !== defaultOption);
            // é‡å»ºæ•°ç»„ï¼Œé»˜è®¤é€‰é¡¹åœ¨ç¬¬ä¸€ä½
            options = [defaultOption, ...filteredOptions];
        }
        
        // å¦‚æœå½“å‰é€‰æ‹©é¡¹ä¸å†å¯ç”¨ï¼Œä½¿ç”¨é»˜è®¤é€‰é¡¹
        const finalSelection = (options.includes(currentlySelected) && currentlySelected) 
            ? currentlySelected 
            : (defaultOption || options[0]);
        
        // ç”Ÿæˆé€‰é¡¹å¹¶è®¾ç½®é€‰ä¸­é¡¹
        selectElement.innerHTML = options.map(option => 
            `<option value="${option}" ${option === finalSelection ? 'selected' : ''}>${option}</option>`
        ).join('');
        
        return finalSelection;
    }

    // è‡ªå®šä¹‰æ’åºå‡½æ•°
    function getTopicOrder(topic) {
        const order = ['å‹åŠ›çš„æ·é”', 'æ¾å¼›æŠ€å·§', 'å‘¼å¸æŠ€å·§', 'è¥å…»å’Œé£Ÿç‰©', 'æ­£é¢è‡ªè¯­'];
        const index = order.indexOf(topic);
        return index === -1 ? 999 : index; // æœªçŸ¥ä¸»é¢˜æ’åœ¨æœ€å
    }

    function getSessionOrder(session) {
        const order = ['è¯¾æ—¶ä¸€', 'è¯¾æ—¶äºŒ', 'è¯¾æ—¶ä¸‰'];
        const index = order.indexOf(session);
        return index === -1 ? 999 : index; // æœªçŸ¥è¯¾æ—¶æ’åœ¨æœ€å
    }

    // æ­£ç¡®æ¯”è¾ƒè¯¾æ—¶æ•°å­—çš„å‡½æ•° - ä½¿ç”¨è‡ªå®šä¹‰æ’åº
    function compareSessionNumbers(a, b) {
        return getSessionOrder(a) - getSessionOrder(b);
    }

    function applyFilters() {
        if (allTasks.length === 0 && students.length === 0) {
            filterTeacher.innerHTML = ''; 
            filterTopic.innerHTML = '';
            filterSession.innerHTML = '';
            filterStudent.innerHTML = '';
            renderEmpty();
            return;
        }
        
        // è·å–å½“å‰é€‰æ‹©çš„ç­›é€‰æ¡ä»¶
        const currentSelectedTeacher = filterTeacher.value || 'æ‰€æœ‰æ•™å¸ˆ';
        // ğŸ‘‰ åº”ç”¨ä¸»æ¨¡å—æ¨¡å¼è¿‡æ»¤
        if (currentMainSection === 'teaching') {
    currentViewMode = 'teacher-only';
    document.querySelector('input[name="view-mode"][value="teacher-only"]').checked = true;
} else if (currentMainSection === 'learning') {
    currentViewMode = 'student-only';
    document.querySelector('input[name="view-mode"][value="student-only"]').checked = true;
}
updateFilterVisibility();
        const currentSelectedStudent = filterStudent.value || 'æ‰€æœ‰å­¦ç”Ÿ';
        const currentSelectedTopic = filterTopic.value || 'æ‰€æœ‰ä¸»é¢˜';
        const currentSelectedSession = filterSession.value || 'æ‰€æœ‰è¯¾æ—¶'; 
        const dateStart = filterDateStart.value;
        const dateEnd = filterDateEnd.value;
        
        console.log("å½“å‰ç­›é€‰æ¡ä»¶:", {
            æ•™å¸ˆ: currentSelectedTeacher,
            å­¦ç”Ÿ: currentSelectedStudent,
            ä¸»é¢˜: currentSelectedTopic,
            è¯¾æ—¶: currentSelectedSession,
            è§†å›¾æ¨¡å¼: currentViewMode,
            å¼€å§‹æ—¥æœŸ: dateStart || "æœªè®¾ç½®",
            ç»“æŸæ—¥æœŸ: dateEnd || "æœªè®¾ç½®"
        });
        
        // å‡†å¤‡æ•™å¸ˆå’Œå­¦ç”Ÿæ•°æ®çš„ç­›é€‰é€‰é¡¹
        let teacherTopics = [];
        let teacherSessions = [];
        let teacherNames = [];
        
        if (currentViewMode !== 'student-only') {
            teacherTopics = [...new Set(allTasks.map(t => t.topic))];
            teacherSessions = [...new Set(allTasks.map(t => t.session))];
            teacherNames = [...new Set(allTasks.map(t => t.teacher))];
        }
        
        let studentTopics = [];
        let studentSessions = [];
        let studentNames = [];
        
        if (currentViewMode !== 'teacher-only') {
            students.forEach(student => {
                studentNames.push(student.name);
                (student.studySessions || []).forEach(session => {
                    if (session.topic) studentTopics.push(session.topic);
                    if (session.session) studentSessions.push(session.session);
                });
            });
        }
        
        // åˆå¹¶ä¸»é¢˜ã€è¯¾æ—¶å’Œåç§°åˆ—è¡¨ï¼Œå¹¶ä½¿ç”¨è‡ªå®šä¹‰æ’åº
        const uniqueTopics = [...new Set([...teacherTopics, ...studentTopics])];
        uniqueTopics.sort((a, b) => getTopicOrder(a) - getTopicOrder(b));
        
        const uniqueSessions = [...new Set([...teacherSessions, ...studentSessions])];
        uniqueSessions.sort(compareSessionNumbers);
        
        const uniqueStudentNames = [...new Set(studentNames)].sort();
        
        // å¡«å……ç­›é€‰ä¸‹æ‹‰æ¡†
        populateFilterDropdown(filterTeacher, teacherNames, currentSelectedTeacher, 'æ‰€æœ‰æ•™å¸ˆ');
        populateFilterDropdown(filterStudent, uniqueStudentNames, currentSelectedStudent, 'æ‰€æœ‰å­¦ç”Ÿ');
        populateFilterDropdown(filterTopic, uniqueTopics, currentSelectedTopic, 'æ‰€æœ‰ä¸»é¢˜');
        populateFilterDropdown(filterSession, uniqueSessions, currentSelectedSession, 'æ‰€æœ‰è¯¾æ—¶');
        
        // å‡†å¤‡è¦æ¸²æŸ“çš„æ•°æ®
        let tasksToRender = [];
        let studySessionsToRender = [];
        
        // ç­›é€‰æ•™å¸ˆè¯¾ç¨‹
        if (currentViewMode !== 'student-only') {
            tasksToRender = allTasks.filter(task => {
                const teacherMatch = (currentSelectedTeacher === 'æ‰€æœ‰æ•™å¸ˆ' || task.teacher === currentSelectedTeacher);
                const topicMatch = (currentSelectedTopic === 'æ‰€æœ‰ä¸»é¢˜' || task.topic === currentSelectedTopic);
                const sessionMatch = (currentSelectedSession === 'æ‰€æœ‰è¯¾æ—¶' || 
                                    (task.session && task.session === currentSelectedSession));
                const dateMatch = (!dateStart || task.sessionEnd >= dateStart) && 
                                (!dateEnd || task.sessionStart <= dateEnd);
                return teacherMatch && topicMatch && sessionMatch && dateMatch;
            });
        }
        
        // ç­›é€‰å­¦ç”Ÿå­¦ä¹ è®°å½•
        if (currentViewMode !== 'teacher-only') {
            const filteredStudents = currentSelectedStudent === 'æ‰€æœ‰å­¦ç”Ÿ' 
                ? students 
                : students.filter(s => s.name === currentSelectedStudent);
                
            studySessionsToRender = [];
            
            filteredStudents.forEach(student => {
                (student.studySessions || []).filter(session => {
                    const topicMatch = (currentSelectedTopic === 'æ‰€æœ‰ä¸»é¢˜' || session.topic === currentSelectedTopic);
                    const sessionMatch = (currentSelectedSession === 'æ‰€æœ‰è¯¾æ—¶' || session.session === currentSelectedSession);
                    const dateMatch = (!dateStart || (!session.endTime || session.endTime >= dateStart)) && 
                                    (!dateEnd || (!session.startTime || session.startTime <= dateEnd));
                    return topicMatch && sessionMatch && dateMatch;
                }).forEach(session => {
                    studySessionsToRender.push({
                        ...session,
                        studentName: student.name,
                        studentId: student.id
                    });
                });
            });
        }
        
        console.log(`ç­›é€‰å: ${tasksToRender.length}ä¸ªæ•™å¸ˆè¯¾ç¨‹, ${studySessionsToRender.length}ä¸ªå­¦ç”Ÿå­¦ä¹ è®°å½•`);
        
        updateColors();
        
        if (currentView === 'gantt') {
            renderGantt(tasksToRender, studySessionsToRender);
        } else {
            renderCalendar(tasksToRender, studySessionsToRender);
        }
    }
    
    function updateColors() {
        const allTopics = new Set([
            ...allTasks.map(t => t.topic),
            ...students.flatMap(s => (s.studySessions || []).map(session => session.topic))
        ]);
        
        [...allTopics].sort().forEach((topic, index) => {
            if (!topicColors[topic] && topic) { 
                topicColors[topic] = colors[index % colors.length]; 
            }
        });
    }

    function addInteractionListeners(task, element, isCourseBar = false) {
        element.addEventListener('mouseover', (e) => {
            if (currentView === 'gantt') {
                const rowIndex = element.dataset.rowIndex; if (!rowIndex) return;
                const relatedElements = document.querySelectorAll(`[data-row-index='${rowIndex}']`);
                ganttView.querySelector('.gantt-chart').classList.add('is-hovering');
                element.classList.add('is-hovered'); 
                relatedElements.forEach(el => el.classList.add('highlight'));
            }
            showTooltip(e, task, isCourseBar);
        });
        element.addEventListener('mousemove', (e) => { updateTooltipPosition(e); });
        element.addEventListener('mouseout', () => {
            if (currentView === 'gantt') {
                const rowIndex = element.dataset.rowIndex; if (!rowIndex) return;
                const relatedElements = document.querySelectorAll(`[data-row-index='${rowIndex}']`);
                ganttView.querySelector('.gantt-chart').classList.remove('is-hovering');
                element.classList.remove('is-hovered');
                relatedElements.forEach(el => el.classList.remove('highlight'));
            }
            hideTooltip();
        });
    }
    
    // å­¦ç”Ÿå­¦ä¹ è®°å½•æ‚¬åœäº¤äº’
    function addStudyInteractionListeners(studySession, element) {
        element.addEventListener('mouseover', (e) => {
            if (currentView === 'gantt') {
                const rowIndex = element.dataset.rowIndex; if (!rowIndex) return;
                const relatedElements = document.querySelectorAll(`[data-row-index='${rowIndex}']`);
                ganttView.querySelector('.gantt-chart').classList.add('is-hovering');
                element.classList.add('is-hovered'); 
                relatedElements.forEach(el => el.classList.add('highlight'));
            }
            showStudyTooltip(e, studySession);
        });
        element.addEventListener('mousemove', (e) => { updateTooltipPosition(e); });
        element.addEventListener('mouseout', () => {
            if (currentView === 'gantt') {
                const rowIndex = element.dataset.rowIndex; if (!rowIndex) return;
                const relatedElements = document.querySelectorAll(`[data-row-index='${rowIndex}']`);
                ganttView.querySelector('.gantt-chart').classList.remove('is-hovering');
                element.classList.remove('is-hovered');
                relatedElements.forEach(el => el.classList.remove('highlight'));
            }
            hideTooltip();
        });
    }

    function showTooltip(event, task, isCourseBar) {
        const parseDate = (str) => new Date(Date.UTC(...str.split('-').map((n, i) => i === 1 ? n - 1 : n)));
        const diffDays = (d1, d2) => Math.round((d2 - d1) / (1000 * 60 * 60 * 24)) + 1;
        let title, start, end, duration;
        
        if (isCourseBar) { 
            title = "è¯¾ç¨‹æ€»è§ˆ"; 
            start = task.courseStart; 
            end = task.courseEnd; 
            duration = diffDays(parseDate(start), parseDate(end));
        } 
        else { 
            title = `è¯¾æ—¶: ${task.session}`; 
            start = task.sessionStart; 
            end = task.sessionEnd; 
            duration = diffDays(parseDate(start), parseDate(end));
        }
        
        tooltip.innerHTML = `
            <div class="tooltip-row"><span class="tooltip-label">${title}</span></div>
            <hr style="border-color: #555; border-style: solid; margin: 5px 0;">
            <div class="tooltip-row"><span class="tooltip-label">ä¸»é¢˜:</span> <span class="tooltip-value">${task.topic}</span></div>
            <div class="tooltip-row"><span class="tooltip-label">è´Ÿè´£äºº:</span> <span class="tooltip-value">${task.teacher}</span></div>
            <div class="tooltip-row"><span class="tooltip-label">å¼€å§‹:</span> <span class="tooltip-value">${start}</span></div>
            <div class="tooltip-row"><span class="tooltip-label">ç»“æŸ:</span> <span class="tooltip-value">${end}</span></div>
            <div class="tooltip-row"><span class="tooltip-label">æ—¶é•¿:</span> <span class="tooltip-value">${duration} å¤©</span></div>
        `;
        
        updateTooltipPosition(event);
        tooltip.classList.add('visible');
    }
    
    // å­¦ç”Ÿå­¦ä¹ è®°å½•æ‚¬åœæç¤º
    function showStudyTooltip(event, studySession) {
        const parseDate = (str) => str ? new Date(Date.UTC(...str.split('-').map((n, i) => i === 1 ? n - 1 : n))) : new Date();
        const diffDays = (d1, d2) => Math.round((d2 - d1) / (1000 * 60 * 60 * 24)) + 1;
        
        const start = studySession.startTime || 'æœªè®¾ç½®';
        const end = studySession.endTime || 'æœªè®¾ç½®';
        let duration = 'æœªçŸ¥';
        
        if (studySession.startTime && studySession.endTime) {
            duration = diffDays(parseDate(start), parseDate(end)) + ' å¤©';
        } else if (studySession.duration) {
            duration = studySession.duration + ' åˆ†é’Ÿ';
        }
        
        const completedText = studySession.completed ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­';
        const notesText = studySession.notes ? 
            `<div class="tooltip-row"><span class="tooltip-label">ç¬”è®°:</span> <span class="tooltip-value">${studySession.notes}</span></div>` : '';
        
        tooltip.innerHTML = `
            <div class="tooltip-row"><span class="tooltip-label">å­¦ä¹ è®°å½•: ${studySession.studentName}</span></div>
            <hr style="border-color: #555; border-style: solid; margin: 5px 0;">
            <div class="tooltip-row"><span class="tooltip-label">ä¸»é¢˜:</span> <span class="tooltip-value">${studySession.topic}</span></div>
            <div class="tooltip-row"><span class="tooltip-label">è¯¾æ—¶:</span> <span class="tooltip-value">${studySession.session}</span></div>
            <div class="tooltip-row"><span class="tooltip-label">å¼€å§‹:</span> <span class="tooltip-value">${start}</span></div>
            <div class="tooltip-row"><span class="tooltip-label">ç»“æŸ:</span> <span class="tooltip-value">${end}</span></div>
            <div class="tooltip-row"><span class="tooltip-label">æ—¶é•¿:</span> <span class="tooltip-value">${duration}</span></div>
            <div class="tooltip-row"><span class="tooltip-label">çŠ¶æ€:</span> <span class="tooltip-value">${completedText}</span></div>
            ${notesText}
        `;
        
        updateTooltipPosition(event);
        tooltip.classList.add('visible');
    }
    
    function hideTooltip() { tooltip.classList.remove('visible'); }
    function updateTooltipPosition(event) { tooltip.style.left = `${event.clientX}px`; tooltip.style.top = `${event.clientY - 15}px`; }

    function toggleGroup(groupName) {
        if (collapsedGroups.has(groupName)) {
            collapsedGroups.delete(groupName);
        } else {
            collapsedGroups.add(groupName);
        }
        
        applyFilters();
    }

    function renderEmpty() {
        const emptyMessage = 'æ²¡æœ‰æ•°æ®å¯ä¾›æ˜¾ç¤ºã€‚';
        if (currentView === 'gantt') {
            ganttTasksContainer.innerHTML = '<div class="gantt-task-header">è´Ÿè´£äºº / è¯¾ç¨‹</div>';
            ganttGrid.innerHTML = `<div class="empty-state">${emptyMessage}</div>`;
        } else {
            calendarView.innerHTML = `<div class="empty-state">${emptyMessage}</div>`;
        }
    }

    function createUserSelector() {
        const existingSelector = document.querySelector('.user-selector');
        if (existingSelector) {
            existingSelector.remove();
        }
        
        const userSelector = document.createElement('div');
        userSelector.className = 'user-selector';
        
        const title = document.createElement('div');
        title.className = 'user-selector-title';
        title.textContent = 'é€‰æ‹©å½“å‰ç”¨æˆ·:';
        userSelector.appendChild(title);
        
        users.forEach(user => {
            const userOption = document.createElement('div');
            userOption.className = 'user-option';
            
            const colorBox = document.createElement('span');
            colorBox.className = `user-color user-${user.id}`;
            colorBox.style.backgroundColor = user.color;
            
            const radioBtn = document.createElement('input');
            radioBtn.type = 'radio';
            radioBtn.name = 'current-user';
            radioBtn.value = user.id;
            radioBtn.id = `user-${user.id}`;
            radioBtn.checked = currentUser === user.id;
            radioBtn.style.marginRight = '5px';
            
            radioBtn.addEventListener('change', function() {
                currentUser = this.value;
            });
            
            const label = document.createElement('label');
            label.htmlFor = `user-${user.id}`;
            label.textContent = user.name;
            
            userOption.appendChild(radioBtn);
            userOption.appendChild(colorBox);
            userOption.appendChild(label);
            userSelector.appendChild(userOption);
        });
        
        const legend = document.createElement('div');
        legend.className = 'user-selector-legend';
        legend.textContent = 'å‹¾é€‰é¢œè‰²ä»£è¡¨ä¸åŒç”¨æˆ·çš„å®ŒæˆçŠ¶æ€';
        
        userSelector.appendChild(legend);
        document.body.appendChild(userSelector);
    }

    function renderCalendar(tasksToRender, studySessionsToRender) {
        calendarView.innerHTML = '';
        const header = document.createElement('div'); header.className = 'calendar-header';
        const nav = document.createElement('div'); nav.className = 'calendar-nav';
        const prevBtn = document.createElement('button'); prevBtn.textContent = 'â€¹ ä¸Šä¸ªæœˆ';
        const todayBtn = document.createElement('button'); todayBtn.textContent = 'ä»Šå¤©';
        const nextBtn = document.createElement('button'); nextBtn.textContent = 'ä¸‹ä¸ªæœˆ â€º';
        nav.append(prevBtn, todayBtn, nextBtn);
        prevBtn.onclick = () => { currentDisplayDate.setMonth(currentDisplayDate.getMonth() - 1); applyFilters(); };
        todayBtn.onclick = () => { currentDisplayDate = new Date(); applyFilters(); };
        nextBtn.onclick = () => { currentDisplayDate.setMonth(currentDisplayDate.getMonth() + 1); applyFilters(); };
        const title = document.createElement('h3'); title.textContent = `${currentDisplayDate.getFullYear()}å¹´ ${currentDisplayDate.getMonth() + 1}æœˆ`;
        header.append(nav, title);
        
        createUserSelector();
        
        const gridContainer = document.createElement('div'); gridContainer.className = 'calendar-grid-container';
        const weekdays = document.createElement('div'); weekdays.className = 'calendar-weekdays';
        ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].forEach(day => { const dayEl = document.createElement('div'); dayEl.textContent = day; weekdays.appendChild(dayEl); });
        const grid = document.createElement('div'); grid.className = 'calendar-grid';
        const year = currentDisplayDate.getFullYear(); const month = currentDisplayDate.getMonth();
        const firstDay = new Date(year, month, 1); const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate(); const startDayOfWeek = firstDay.getDay();
        for (let i = 0; i < startDayOfWeek; i++) { const dayCell = document.createElement('div'); dayCell.className = 'calendar-day other-month'; grid.appendChild(dayCell); }
        const today = new Date(); const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        for (let i = 1; i <= daysInMonth; i++) {
            const dayCell = document.createElement('div'); dayCell.className = 'calendar-day';
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            dayCell.dataset.date = dateStr;
            if (dateStr === todayStr) dayCell.classList.add('today');
            const dayNumber = document.createElement('div'); dayNumber.className = 'day-number'; dayNumber.textContent = i;
            dayCell.appendChild(dayNumber); grid.appendChild(dayCell);
        }
        
        // æ¸²æŸ“æ•™å¸ˆè¯¾ç¨‹
        if (currentViewMode !== 'student-only') {
            const processedCourses = new Set(); 
            tasksToRender.forEach(task => {
                const courseKey = `${task.teacher}-${task.topic}-${task.session}-${task.courseStart}-${task.courseEnd}`;
                if (processedCourses.has(courseKey)) return;
                processedCourses.add(courseKey);
                
                const courseStartDate = new Date(task.courseStart + 'T00:00:00'); 
                const courseEndDate = new Date(task.courseEnd + 'T00:00:00');
                
                const isInfoTeacher = task.teacher.includes('ä¿¡æ¯è€å¸ˆ') || task.teacher === 'ä¿¡æ¯è€å¸ˆ';
                
                if (task.courseStart === task.courseEnd) {
                    if (courseStartDate.getFullYear() === year && courseStartDate.getMonth() === month) {
                        const dayCell = grid.querySelector(`.calendar-day[data-date="${task.courseStart}"]`);
                        if (dayCell) { 
                            const marker = document.createElement('div'); 
                            
                            const taskId = `task-${task.teacher}-${task.topic}-${task.session}-single-${task.courseStart}`;
                            marker.dataset.taskId = taskId;
                            
                            if (isInfoTeacher) {
                                marker.className = 'calendar-marker marker-info-teacher';
                            } else {
                                marker.className = 'calendar-marker marker-single-day';
                            }
                            
                            const taskChecks = checkStatus[taskId] || {};
                            
                            const checkContainer = document.createElement('div');
                            checkContainer.className = 'multi-checkbox';
                            
                            users.forEach(user => {
                                const isChecked = taskChecks[user.id] || false;
                                
                                const checkboxContainer = document.createElement('div');
                                checkboxContainer.className = 'checkbox-container';
                                
                                const checkbox = document.createElement('input');
                                checkbox.type = 'checkbox';
                                checkbox.className = 'user-checkbox';
                                checkbox.dataset.userId = user.id;
                                checkbox.checked = isChecked;
                                
                                const checkboxDisplay = document.createElement('div');
                                checkboxDisplay.className = `checkbox-display ${user.id}`;
                                
                                checkbox.addEventListener('change', function() {
                                    const isChecked = checkbox.checked;
                                    saveMultiUserCheckStatus(taskId, user.id, isChecked);
                                    
                                    if (isChecked) {
                                        showFeedback(marker, user.id);
                                    }
                                });
                                
                                checkboxContainer.appendChild(checkbox);
                                checkboxContainer.appendChild(checkboxDisplay);
                                checkContainer.appendChild(checkboxContainer);
                            });
                            
                            marker.prepend(checkContainer);
                            
                            marker.appendChild(document.createTextNode(
                                `${task.teacher} - ${task.topic}${task.session ? '-' + task.session : ''}`
                            ));
                            
                            addInteractionListeners(task, marker, true); 
                            dayCell.appendChild(marker);
                        }
                    }
                } else {
                    // å¼€è¯¾æ—¥
                    if (courseStartDate.getFullYear() === year && courseStartDate.getMonth() === month) {
                        const startCell = grid.querySelector(`.calendar-day[data-date="${task.courseStart}"]`);
                        if (startCell) { 
                            const marker = document.createElement('div'); 
                            
                            const taskId = `task-${task.teacher}-${task.topic}-${task.session}-start-${task.courseStart}`;
                            marker.dataset.taskId = taskId;
                            
                            if (isInfoTeacher) {
                                marker.className = 'calendar-marker marker-info-start';
                            } else {
                                marker.className = 'calendar-marker marker-start';
                            }
                            
                            const taskChecks = checkStatus[taskId] || {};
                            
                            const checkContainer = document.createElement('div');
                            checkContainer.className = 'multi-checkbox';
                            
                            users.forEach(user => {
                                const isChecked = taskChecks[user.id] || false;
                                
                                const checkboxContainer = document.createElement('div');
                                checkboxContainer.className = 'checkbox-container';
                                
                                const checkbox = document.createElement('input');
                                checkbox.type = 'checkbox';
                                checkbox.className = 'user-checkbox';
                                checkbox.dataset.userId = user.id;
                                checkbox.checked = isChecked;
                                
                                const checkboxDisplay = document.createElement('div');
                                checkboxDisplay.className = `checkbox-display ${user.id}`;
                                
                                checkbox.addEventListener('change', function() {
                                    const isChecked = checkbox.checked;
                                    saveMultiUserCheckStatus(taskId, user.id, isChecked);
                                    
                                    if (isChecked) {
                                        showFeedback(marker, user.id);
                                    }
                                });
                                
                                checkboxContainer.appendChild(checkbox);
                                checkboxContainer.appendChild(checkboxDisplay);
                                checkContainer.appendChild(checkboxContainer);
                            });
                            
                            marker.prepend(checkContainer);
                            
                            marker.appendChild(document.createTextNode(
                                `${task.teacher} - ${task.topic}${task.session ? '-' + task.session : ''} (å¤‡)`
                            ));
                            
                            addInteractionListeners(task, marker, true); 
                            startCell.appendChild(marker);
                        }
                    }
                    // ç»“è¯¾æ—¥
                    if (courseEndDate.getFullYear() === year && courseEndDate.getMonth() === month) {
                        const endCell = grid.querySelector(`.calendar-day[data-date="${task.courseEnd}"]`);
                        if (endCell) { 
                            const marker = document.createElement('div'); 
                            
                            const taskId = `task-${task.teacher}-${task.topic}-${task.session}-end-${task.courseEnd}`;
                            marker.dataset.taskId = taskId;
                            
                            if (isInfoTeacher) {
                                marker.className = 'calendar-marker marker-info-end';
                            } else {
                                marker.className = 'calendar-marker marker-end';
                            }
                            
                            const taskChecks = checkStatus[taskId] || {};
                            
                            const checkContainer = document.createElement('div');
                            checkContainer.className = 'multi-checkbox';
                            
                            users.forEach(user => {
                                const isChecked = taskChecks[user.id] || false;
                                
                                const checkboxContainer = document.createElement('div');
                                checkboxContainer.className = 'checkbox-container';
                                
                                const checkbox = document.createElement('input');
                                checkbox.type = 'checkbox';
                                checkbox.className = 'user-checkbox';
                                checkbox.dataset.userId = user.id;
                                checkbox.checked = isChecked;
                                
                                const checkboxDisplay = document.createElement('div');
                                checkboxDisplay.className = `checkbox-display ${user.id}`;
                                
                                checkbox.addEventListener('change', function() {
                                    const isChecked = checkbox.checked;
                                    saveMultiUserCheckStatus(taskId, user.id, isChecked);
                                    
                                    if (isChecked) {
                                        showFeedback(marker, user.id);
                                    }
                                });
                                
                                checkboxContainer.appendChild(checkbox);
                                checkboxContainer.appendChild(checkboxDisplay);
                                checkContainer.appendChild(checkboxContainer);
                            });
                            
                            marker.prepend(checkContainer);
                            
                            marker.appendChild(document.createTextNode(
                                `${task.teacher} - ${task.topic}${task.session ? '-' + task.session : ''} (å…³)`
                            ));
                            
                            addInteractionListeners(task, marker, true); 
                            endCell.appendChild(marker);
                        }
                    }
                }
            });
        }
        
        // æ¸²æŸ“å­¦ç”Ÿå­¦ä¹ è®°å½•
        if (currentViewMode !== 'teacher-only' && studySessionsToRender.length > 0) {
            studySessionsToRender.forEach(session => {
                if (!session.startTime || !session.endTime) return; // è·³è¿‡æ²¡æœ‰æ—¥æœŸçš„è®°å½•
                
                const studyStartDate = new Date(session.startTime + 'T00:00:00');
                const studyEndDate = new Date(session.endTime + 'T00:00:00');
                
                if (session.startTime === session.endTime) {
                    // å•æ—¥å­¦ä¹ 
                    if (studyStartDate.getFullYear() === year && studyStartDate.getMonth() === month) {
                        const dayCell = grid.querySelector(`.calendar-day[data-date="${session.startTime}"]`);
                        if (dayCell) { 
                            const marker = document.createElement('div');
                            
                            const taskId = `student-${session.studentName}-${session.topic}-${session.session}-single-${session.startTime}`;
                            marker.dataset.taskId = taskId;
                            
                            marker.className = `calendar-marker student-marker ${session.completed ? 'completed' : ''}`;
                            
                            const taskChecks = checkStatus[taskId] || {};
                            
                            const checkContainer = document.createElement('div');
                            checkContainer.className = 'multi-checkbox';
                            
                            users.forEach(user => {
                                const isChecked = taskChecks[user.id] || false;
                                
                                const checkboxContainer = document.createElement('div');
                                checkboxContainer.className = 'checkbox-container';
                                
                                const checkbox = document.createElement('input');
                                checkbox.type = 'checkbox';
                                checkbox.className = 'user-checkbox';
                                checkbox.dataset.userId = user.id;
                                checkbox.checked = isChecked;
                                
                                const checkboxDisplay = document.createElement('div');
                                checkboxDisplay.className = `checkbox-display ${user.id}`;
                                
                                checkbox.addEventListener('change', function() {
                                    const isChecked = checkbox.checked;
                                    saveMultiUserCheckStatus(taskId, user.id, isChecked);
                                    
                                    if (isChecked) {
                                        showFeedback(marker, user.id);
                                    }
                                });
                                
                                checkboxContainer.appendChild(checkbox);
                                checkboxContainer.appendChild(checkboxDisplay);
                                checkContainer.appendChild(checkboxContainer);
                            });
                            
                            marker.prepend(checkContainer);
                            
                            marker.appendChild(document.createTextNode(
                                `${session.studentName} - ${session.topic} ${session.session}`
                            ));
                            
                            // æ·»åŠ æ‚¬åœäº¤äº’
                            addStudyInteractionListeners(session, marker);
                            dayCell.appendChild(marker);
                        }
                    }
                } else {
                    // å¼€å§‹å­¦ä¹ æ—¥
                    if (studyStartDate.getFullYear() === year && studyStartDate.getMonth() === month) {
                        const startCell = grid.querySelector(`.calendar-day[data-date="${session.startTime}"]`);
                        if (startCell) { 
                            const marker = document.createElement('div');
                            
                            const taskId = `student-${session.studentName}-${session.topic}-${session.session}-start-${session.startTime}`;
                            marker.dataset.taskId = taskId;
                            
                            marker.className = `calendar-marker student-marker ${session.completed ? 'completed' : ''}`;
                            
                            const taskChecks = checkStatus[taskId] || {};
                            
                            const checkContainer = document.createElement('div');
                            checkContainer.className = 'multi-checkbox';
                            
                            users.forEach(user => {
                                const isChecked = taskChecks[user.id] || false;
                                
                                const checkboxContainer = document.createElement('div');
                                checkboxContainer.className = 'checkbox-container';
                                
                                const checkbox = document.createElement('input');
                                checkbox.type = 'checkbox';
                                checkbox.className = 'user-checkbox';
                                checkbox.dataset.userId = user.id;
                                checkbox.checked = isChecked;
                                
                                const checkboxDisplay = document.createElement('div');
                                checkboxDisplay.className = `checkbox-display ${user.id}`;
                                
                                checkbox.addEventListener('change', function() {
                                    const isChecked = checkbox.checked;
                                    saveMultiUserCheckStatus(taskId, user.id, isChecked);
                                    
                                    if (isChecked) {
                                        showFeedback(marker, user.id);
                                    }
                                });
                                
                                checkboxContainer.appendChild(checkbox);
                                checkboxContainer.appendChild(checkboxDisplay);
                                checkContainer.appendChild(checkboxContainer);
                            });
                            
                            marker.prepend(checkContainer);
                            
                            marker.appendChild(document.createTextNode(
                                `${session.studentName} - ${session.topic} ${session.session} (å¼€å§‹)`
                            ));
                            
                            addStudyInteractionListeners(session, marker);
                            startCell.appendChild(marker);
                        }
                    }
                    
                    // ç»“æŸå­¦ä¹ æ—¥
                    if (studyEndDate.getFullYear() === year && studyEndDate.getMonth() === month) {
                        const endCell = grid.querySelector(`.calendar-day[data-date="${session.endTime}"]`);
                        if (endCell) { 
                            const marker = document.createElement('div');
                            
                            const taskId = `student-${session.studentName}-${session.topic}-${session.session}-end-${session.endTime}`;
                            marker.dataset.taskId = taskId;
                            
                            marker.className = `calendar-marker student-marker ${session.completed ? 'completed' : ''}`;
                            
                            const taskChecks = checkStatus[taskId] || {};
                            
                            const checkContainer = document.createElement('div');
                            checkContainer.className = 'multi-checkbox';
                            
                            users.forEach(user => {
                                const isChecked = taskChecks[user.id] || false;
                                
                                const checkboxContainer = document.createElement('div');
                                checkboxContainer.className = 'checkbox-container';
                                
                                const checkbox = document.createElement('input');
                                checkbox.type = 'checkbox';
                                checkbox.className = 'user-checkbox';
                                checkbox.dataset.userId = user.id;
                                checkbox.checked = isChecked;
                                
                                const checkboxDisplay = document.createElement('div');
                                checkboxDisplay.className = `checkbox-display ${user.id}`;
                                
                                checkbox.addEventListener('change', function() {
                                    const isChecked = checkbox.checked;
                                    saveMultiUserCheckStatus(taskId, user.id, isChecked);
                                    
                                    if (isChecked) {
                                        showFeedback(marker, user.id);
                                    }
                                });
                                
                                checkboxContainer.appendChild(checkbox);
                                checkboxContainer.appendChild(checkboxDisplay);
                                checkContainer.appendChild(checkboxContainer);
                            });
                            
                            marker.prepend(checkContainer);
                            
                            marker.appendChild(document.createTextNode(
                                `${session.studentName} - ${session.topic} ${session.session} (ç»“æŸ)`
                            ));
                            
                            addStudyInteractionListeners(session, marker);
                            endCell.appendChild(marker);
                        }
                    }
                }
            });
        }
        
        // [æ–°å¢åŠŸèƒ½å¼€å§‹ - å·²ä¿®æ­£]
        // æ­¤å¤„æ·»åŠ æ•™å¸ˆè¯¾ç¨‹çš„èµ·å§‹/ç»“æŸæ—¥æœŸæ–‡å­—æ³¨è®°
        if (currentViewMode !== 'student-only') {
            const startNotesSet = new Set();
            const endNotesSet = new Set();
            
            tasksToRender.forEach(task => {
                // ä¿®æ­£ï¼šç¡®ä¿è¯¾æ—¶æœ‰èµ·æ­¢æ—¥æœŸ (sessionStart, sessionEnd)
                if (!task.sessionStart || !task.sessionEnd) return;

                const sessionStartDate = new Date(task.sessionStart + 'T00:00:00');
                const sessionEndDate = new Date(task.sessionEnd + 'T00:00:00');

                // 1. å¤„ç†èµ·å§‹æ—¥æœŸæ³¨è®° ("èµ·å§‹æ—¥æœŸ" -> sessionStart)
                if (sessionStartDate.getFullYear() === year && sessionStartDate.getMonth() === month) {
                    // åˆ›å»ºå”¯ä¸€é”®ä»¥é˜²é‡å¤æ·»åŠ 
                    const key = `${task.teacher}|${task.topic}|${task.session}|${task.sessionStart}|up`;
                    if (!startNotesSet.has(key)) {
                        const startCell = grid.querySelector(`.calendar-day[data-date="${task.sessionStart}"]`);
                        if (startCell) {
                            const note = document.createElement('div');
                            note.className = 'calendar-text-note';
                            note.textContent = `${task.teacher}è€å¸ˆ-${(task.topic || '')}${(task.session || '')}-ä¸Š`;
                            
                            // å°†æ³¨è®°æ’å…¥åˆ°æ—¥æœŸæ•°å­—çš„åé¢
                            const dayNum = startCell.querySelector('.day-number');
                            if (dayNum && dayNum.nextSibling) {
                                startCell.insertBefore(note, dayNum.nextSibling);
                            } else {
                                startCell.appendChild(note);
                            }
                            startNotesSet.add(key);
                        }
                    }
                }
                
                // 2. å¤„ç†ç»“æŸæ—¥æœŸæ³¨è®° ("ç»“æŸæ—¥æœŸ" -> sessionEnd)
                if (sessionEndDate.getFullYear() === year && sessionEndDate.getMonth() === month) {
                    // åˆ›å»ºå”¯ä¸€é”®ä»¥é˜²é‡å¤æ·»åŠ 
                    const key = `${task.teacher}|${task.topic}|${task.session}|${task.sessionEnd}|down`;
                    if (!endNotesSet.has(key)) {
                        const endCell = grid.querySelector(`.calendar-day[data-date="${task.sessionEnd}"]`);
                        if (endCell) {
                            const note = document.createElement('div');
                            note.className = 'calendar-text-note';
                            note.textContent = `${task.teacher}è€å¸ˆ-${(task.topic || '')}${(task.session || '')}-ä¸‹`;
                            
                            // å°†æ³¨è®°æ’å…¥åˆ°æ—¥æœŸæ•°å­—çš„åé¢
                            const dayNum = endCell.querySelector('.day-number');
                            if (dayNum && dayNum.nextSibling) {
                                endCell.insertBefore(note, dayNum.nextSibling);
                            } else {
                                endCell.appendChild(note);
                            }
                            endNotesSet.add(key);
                        }
                    }
                }
            });
        }
        // [æ–°å¢åŠŸèƒ½ç»“æŸ]

        gridContainer.append(weekdays, grid);
        calendarView.append(header, gridContainer);
    }

    function renderGantt(tasksToRender, studySessionsToRender) {
        ganttTasksContainer.innerHTML = '<div class="gantt-task-header">è´Ÿè´£äºº / è¯¾ç¨‹</div>';
        ganttGrid.innerHTML = `<div class="gantt-timeline"><div class="gantt-months"></div><div class="gantt-days"></div></div><div class="gantt-rows"></div>`;
        const ganttMonths = ganttGrid.querySelector('.gantt-months');
        const ganttDays = ganttGrid.querySelector('.gantt-days');
        const ganttRows = ganttGrid.querySelector('.gantt-rows');
        const parseDate = (str) => new Date(Date.UTC(...str.split('-').map((n, i) => i === 1 ? n - 1 : n)));
        const diffDays = (d1, d2) => Math.round((d2 - d1) / (1000 * 60 * 60 * 24));
        
        if (tasksToRender.length === 0 && studySessionsToRender.length === 0) { 
            ganttRows.innerHTML = '<div class="empty-state">æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®ã€‚</div>'; 
            return; 
        }
        
        // æ”¶é›†æ‰€æœ‰æ—¥æœŸï¼ŒåŒ…æ‹¬æ•™å¸ˆå’Œå­¦ç”Ÿæ•°æ®
        const teacherDates = tasksToRender.flatMap(t => t.courseStart && t.courseEnd ? [parseDate(t.courseStart), parseDate(t.courseEnd)] : []);
        const studentDates = studySessionsToRender.flatMap(s => s.startTime && s.endTime ? [parseDate(s.startTime), parseDate(s.endTime)] : []);
        const allDates = [...teacherDates, ...studentDates].filter(Boolean);
        
        if (allDates.length === 0) {
            ganttRows.innerHTML = '<div class="empty-state">æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ—¥æœŸæ•°æ®ã€‚</div>';
            return;
        }
        
        const minDate = new Date(Math.min(...allDates)); 
        const maxDate = new Date(Math.max(...allDates));
        maxDate.setUTCDate(maxDate.getUTCDate() + 7); // å¤šæ˜¾ç¤ºä¸€å‘¨
        
        // åˆ›å»ºç½‘æ ¼çº¿å®¹å™¨
        const ganttGridLines = document.createElement('div'); 
        ganttGridLines.className = 'gantt-grid-lines';
        ganttRows.appendChild(ganttGridLines);
        
        let currentDate = new Date(minDate); let months = {}; let dayIndex = 0;
        
        // æ”¹è¿›çš„æ—¥æœŸå’Œç½‘æ ¼çº¿æ¸²æŸ“
        while (currentDate <= maxDate) {
            const dayEl = document.createElement('div'); 
            dayEl.className = 'gantt-day'; 
            dayEl.textContent = currentDate.getUTCDate(); 
            ganttDays.appendChild(dayEl);
            
            // åˆ›å»ºå‚ç›´ç½‘æ ¼çº¿ - ä¿®æ­£ä½ç½®
            const lineEl = document.createElement('div'); 
            lineEl.className = 'gantt-grid-line'; 
            lineEl.style.left = `${dayIndex * dayWidth}px`; // ä»0å¼€å§‹ï¼Œæ¯ä¸ªå•å…ƒæ ¼å·¦ä¾§
            ganttGridLines.appendChild(lineEl);
            
            const monthKey = `${currentDate.getUTCFullYear()}-${currentDate.getUTCMonth()}`;
            if (!months[monthKey]) { 
                months[monthKey] = { 
                    name: `${currentDate.getUTCFullYear()}å¹´ ${currentDate.getUTCMonth() + 1}æœˆ`, 
                    days: 0 
                }; 
            }
            
            months[monthKey].days++; 
            currentDate.setUTCDate(currentDate.getUTCDate() + 1); 
            dayIndex++;
        }
        
        // æ·»åŠ æœ€åä¸€æ¡ç½‘æ ¼çº¿
        const finalLineEl = document.createElement('div');
        finalLineEl.className = 'gantt-grid-line';
        finalLineEl.style.left = `${dayIndex * dayWidth}px`;
        ganttGridLines.appendChild(finalLineEl);
        
        for (const key in months) { 
            const month = months[key]; 
            const monthEl = document.createElement('div'); 
            monthEl.className = 'gantt-month'; 
            monthEl.textContent = month.name; 
            monthEl.style.width = `${month.days * dayWidth}px`; 
            ganttMonths.appendChild(monthEl); 
        }
        
        // è®¡ç®—æ€»å…±éœ€è¦æ¸²æŸ“çš„è¡Œæ•°ï¼ˆç”¨äºè®¾ç½®ç½‘æ ¼é«˜åº¦ï¼‰
        let displayRowIndex = 0;
        
        // æ¸²æŸ“æ•™å¸ˆæ•°æ®
        if (currentViewMode !== 'student-only' && tasksToRender.length > 0) {
            const groupedTasks = tasksToRender.reduce((acc, task) => { 
                (acc[task.teacher] = acc[task.teacher] || []).push(task); 
                return acc; 
            }, {});
            
            const sortedTeachers = Object.keys(groupedTasks).map(teacher => { 
                const tasks = groupedTasks[teacher]; 
                tasks.sort((a, b) => {
                    // é¦–å…ˆæŒ‰ä¸»é¢˜æ’åºï¼ˆä½¿ç”¨è‡ªå®šä¹‰é¡ºåºï¼‰
                    const topicCompare = getTopicOrder(a.topic) - getTopicOrder(b.topic);
                    if (topicCompare !== 0) return topicCompare;
                    
                    // å¦‚æœä¸»é¢˜ç›¸åŒï¼ŒæŒ‰è¯¾æ—¶æ’åºï¼ˆä½¿ç”¨è‡ªå®šä¹‰é¡ºåºï¼‰
                    if (a.session && b.session) {
                        return getSessionOrder(a.session) - getSessionOrder(b.session);
                    }
                    
                    // å¦‚æœä¸€ä¸ªæœ‰è¯¾æ—¶ä¸€ä¸ªæ²¡æœ‰ï¼Œæœ‰è¯¾æ—¶çš„ä¼˜å…ˆ
                    if (a.session) return -1;
                    if (b.session) return 1;
                    
                    // æœ€åæŒ‰å¼€å§‹æ—¥æœŸæ’åº
                    return parseDate(a.sessionStart).getTime() - parseDate(b.sessionStart).getTime();
                }); 
                
                return { 
                    teacher, 
                    tasks, 
                    taskCount: tasks.length, 
                    minDate: new Date(Math.min(...tasks.map(t => parseDate(t.courseStart).getTime()))) 
                }; 
            });
            
            sortedTeachers.sort((a, b) => { 
                if (b.taskCount !== a.taskCount) return b.taskCount - a.taskCount; 
                return a.minDate.getTime() - b.minDate.getTime(); 
            });
            
            // ç»˜åˆ¶æ•™å¸ˆä»»åŠ¡
            sortedTeachers.forEach(({ teacher, tasks }) => {
                const isGroupCollapsed = collapsedGroups.has(teacher);
                
                // ç»˜åˆ¶ç»„æ ‡é¢˜è¡Œï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰
                const groupHeaderEl = document.createElement('div'); 
                groupHeaderEl.className = `gantt-task-group-header`; 
                groupHeaderEl.innerHTML = `<span class="toggle-icon">${isGroupCollapsed ? 'â–º' : 'â–¼'}</span>${teacher}`; 
                groupHeaderEl.dataset.rowIndex = displayRowIndex; 
                groupHeaderEl.dataset.groupName = teacher; 
                groupHeaderEl.addEventListener('click', () => toggleGroup(teacher)); 
                ganttTasksContainer.appendChild(groupHeaderEl);
                
                const headerRowEl = document.createElement('div'); 
                headerRowEl.className = 'gantt-row group-header-row'; 
                headerRowEl.style.width = `${(diffDays(minDate, maxDate) + 1) * dayWidth}px`; 
                headerRowEl.dataset.rowIndex = displayRowIndex; 
                ganttRows.appendChild(headerRowEl);
                
                displayRowIndex++; // ç»„æ ‡é¢˜è¡Œç®—ä¸€è¡Œ
                
                // åªæœ‰å½“ç»„æœªæŠ˜å æ—¶æ‰ç»˜åˆ¶ä»»åŠ¡
                if (!isGroupCollapsed) {
                    tasks.forEach(task => {
                        const taskItemEl = document.createElement('div'); 
                        taskItemEl.className = 'gantt-task-item'; 
                        taskItemEl.innerHTML = `<div class="task-topic">${task.topic}</div><div class="task-session">${task.session || ''}</div>`; 
                        taskItemEl.dataset.rowIndex = displayRowIndex; 
                        taskItemEl.dataset.groupName = teacher; 
                        ganttTasksContainer.appendChild(taskItemEl);
                        
                        const rowEl = document.createElement('div'); 
                        rowEl.className = 'gantt-row'; 
                        rowEl.style.width = `${(diffDays(minDate, maxDate) + 1) * dayWidth}px`; 
                        rowEl.dataset.rowIndex = displayRowIndex; 
                        rowEl.dataset.groupName = teacher; 
                        ganttRows.appendChild(rowEl);
                        
                        // è®¡ç®—è¯¾ç¨‹æ¡ä½ç½®
                        const courseStartOffset = diffDays(minDate, parseDate(task.courseStart)); 
                        const courseDuration = diffDays(parseDate(task.courseStart), parseDate(task.courseEnd)) + 1;
                        
                        const courseBar = document.createElement('div'); 
                        courseBar.className = 'gantt-bar gantt-bar-course'; 
                        courseBar.style.top = `${displayRowIndex * 50}px`;
                        courseBar.style.left = `${courseStartOffset * dayWidth}px`; 
                        courseBar.style.width = `${courseDuration * dayWidth}px`; 
                        courseBar.style.backgroundColor = topicColors[task.topic];
                        courseBar.innerHTML = `<span class="gantt-bar-course-label">å¼€è¯¾</span><span class="gantt-bar-course-text">${task.topic}</span><span class="gantt-bar-course-label">ç»“è¯¾</span>`;
                        courseBar.dataset.rowIndex = displayRowIndex; 
                        courseBar.dataset.groupName = teacher; 
                        ganttRows.appendChild(courseBar); 
                        addInteractionListeners(task, courseBar, true);
                        
                        if (task.sessionStart && task.sessionEnd) {
                            const sessionStartOffset = diffDays(minDate, parseDate(task.sessionStart)); 
                            const sessionDuration = diffDays(parseDate(task.sessionStart), parseDate(task.sessionEnd)) + 1;
                            
                            const sessionBar = document.createElement('div'); 
                            sessionBar.className = 'gantt-bar gantt-bar-session'; 
                            sessionBar.style.top = `${displayRowIndex * 50}px`;
                            sessionBar.style.left = `${sessionStartOffset * dayWidth}px`; 
                            sessionBar.style.width = `${sessionDuration * dayWidth}px`; 
                            sessionBar.style.backgroundColor = topicColors[task.topic];
                            sessionBar.textContent = task.session || '';
                            sessionBar.dataset.rowIndex = displayRowIndex; 
                            sessionBar.dataset.groupName = teacher; 
                            ganttRows.appendChild(sessionBar); 
                            addInteractionListeners(task, sessionBar, false);
                        }
                        
                        displayRowIndex++; // æ¯ä¸ªä»»åŠ¡ä¸€è¡Œ
                    });
                }
            });
        }
        
        // æ¸²æŸ“å­¦ç”Ÿæ•°æ®
        if (currentViewMode !== 'teacher-only' && studySessionsToRender.length > 0) {
            // æŒ‰å­¦ç”Ÿåˆ†ç»„
            const groupedByStudent = {};
            
            studySessionsToRender.forEach(session => {
                if (!groupedByStudent[session.studentName]) {
                    groupedByStudent[session.studentName] = [];
                }
                groupedByStudent[session.studentName].push(session);
            });
            
            // æ¸²æŸ“æ¯ä¸ªå­¦ç”Ÿçš„æ•°æ®
            Object.entries(groupedByStudent).forEach(([studentName, sessions]) => {
                // æ’åºå­¦ç”Ÿçš„å­¦ä¹ è®°å½•ï¼ˆä½¿ç”¨è‡ªå®šä¹‰é¡ºåºï¼‰
                sessions.sort((a, b) => {
                    // é¦–å…ˆæŒ‰ä¸»é¢˜æ’åºï¼ˆä½¿ç”¨è‡ªå®šä¹‰é¡ºåºï¼‰
                    const topicCompare = getTopicOrder(a.topic || '') - getTopicOrder(b.topic || '');
                    if (topicCompare !== 0) return topicCompare;
                    
                    // ç„¶åæŒ‰è¯¾æ—¶æ’åºï¼ˆä½¿ç”¨è‡ªå®šä¹‰é¡ºåºï¼‰
                    if (a.session && b.session) {
                        return getSessionOrder(a.session) - getSessionOrder(b.session);
                    } else if (a.session) {
                        return -1;
                    } else if (b.session) {
                        return 1;
                    }
                    
                    // æœ€åæŒ‰å¼€å§‹æ—¥æœŸæ’åº
                    return (a.startTime || '').localeCompare(b.startTime || '');
                });
                
                const studentGroupId = `student_${studentName}`;
                const isGroupCollapsed = collapsedGroups.has(studentGroupId);
                
                // åˆ›å»ºå­¦ç”Ÿç»„æ ‡é¢˜è¡Œ
                const groupHeaderEl = document.createElement('div'); 
                groupHeaderEl.className = `gantt-task-group-header`; 
                groupHeaderEl.innerHTML = `<span class="toggle-icon">${isGroupCollapsed ? 'â–º' : 'â–¼'}</span>${studentName} (å­¦ç”Ÿ)`; 
                groupHeaderEl.dataset.rowIndex = displayRowIndex; 
                groupHeaderEl.dataset.groupName = studentGroupId; 
                groupHeaderEl.addEventListener('click', () => toggleGroup(studentGroupId)); 
                ganttTasksContainer.appendChild(groupHeaderEl);
                
                const headerRowEl = document.createElement('div'); 
                headerRowEl.className = 'gantt-row group-header-row'; 
                headerRowEl.style.width = `${(diffDays(minDate, maxDate) + 1) * dayWidth}px`; 
                headerRowEl.dataset.rowIndex = displayRowIndex; 
                ganttRows.appendChild(headerRowEl);
                
                displayRowIndex++;
                
                // ä»…å½“ç»„æœªæŠ˜å æ—¶æ‰æ¸²æŸ“å­¦ä¹ è®°å½•
                if (!isGroupCollapsed) {
                    sessions.forEach(session => {
                        if (!session.startTime || !session.endTime) return; // è·³è¿‡æ²¡æœ‰æ—¥æœŸçš„è®°å½•
                        
                        const taskItemEl = document.createElement('div'); 
                        taskItemEl.className = 'gantt-task-item'; 
                        taskItemEl.innerHTML = `<div class="task-topic">${session.topic || 'æœªæŒ‡å®šä¸»é¢˜'}</div>
                                                <div class="task-session">${session.session || 'æœªæŒ‡å®šè¯¾æ—¶'} (å­¦ä¹ è®°å½•)</div>`; 
                        taskItemEl.dataset.rowIndex = displayRowIndex; 
                        taskItemEl.dataset.groupName = studentGroupId; 
                        ganttTasksContainer.appendChild(taskItemEl);
                        
                        const rowEl = document.createElement('div'); 
                        rowEl.className = 'gantt-row'; 
                        rowEl.style.width = `${(diffDays(minDate, maxDate) + 1) * dayWidth}px`; 
                        rowEl.dataset.rowIndex = displayRowIndex; 
                        rowEl.dataset.groupName = studentGroupId; 
                        ganttRows.appendChild(rowEl);
                        
                        // å­¦ä¹ æ—¶é—´æ¡
                        const studyStartOffset = diffDays(minDate, parseDate(session.startTime)); 
                        const studyDuration = diffDays(parseDate(session.startTime), parseDate(session.endTime)) + 1;
                        
                        const studyBar = document.createElement('div'); 
                        studyBar.className = `gantt-bar gantt-bar-student ${session.completed ? 'completed' : ''}`; 
                        studyBar.style.top = `${displayRowIndex * 50}px`;
                        studyBar.style.left = `${studyStartOffset * dayWidth}px`; 
                        studyBar.style.width = `${studyDuration * dayWidth}px`; 
                        studyBar.style.backgroundColor = topicColors[session.topic] || '#3498db'; // ä½¿ç”¨ä¸»é¢˜é¢œè‰²æˆ–é»˜è®¤è“è‰²
                        studyBar.textContent = session.session || '';
                        studyBar.dataset.rowIndex = displayRowIndex; 
                        studyBar.dataset.groupName = studentGroupId; 
                        ganttRows.appendChild(studyBar);
                        
                        // æ·»åŠ äº¤äº’ç›‘å¬
                        addStudyInteractionListeners(session, studyBar);
                        
                        displayRowIndex++;
                    });
                }
            });
        }
        
        // ä»Šæ—¥çº¿æ˜¾ç¤º
        const today = new Date(); 
        const todayUTC = new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate()));
        if (todayUTC >= minDate && todayUTC <= maxDate) { 
            const todayLine = document.createElement('div'); 
            todayLine.className = 'gantt-today-line';
            const todayOffset = diffDays(minDate, todayUTC); 
            todayLine.style.left = `${(todayOffset * dayWidth) + (dayWidth / 2)}px`;
            todayLine.style.display = 'block';
            ganttRows.appendChild(todayLine);
        }
        
        // è®¾ç½®ç½‘æ ¼çº¿é«˜åº¦
        const ganttGridLinesEl = ganttRows.querySelector('.gantt-grid-lines');
        if (ganttGridLinesEl) {
            // è®¡ç®—å®é™…æ˜¾ç¤ºçš„æ€»é«˜åº¦
            const visibleRowsHeight = displayRowIndex * 50; // æ¯è¡Œ50px
            ganttGridLinesEl.style.height = `${visibleRowsHeight}px`;
            
            // ç¡®ä¿æ¯æ¡ç½‘æ ¼çº¿éƒ½æœ‰æ­£ç¡®çš„é«˜åº¦
            const gridLines = ganttGridLinesEl.querySelectorAll('.gantt-grid-line');
            gridLines.forEach(line => {
                line.style.height = `${visibleRowsHeight}px`;
            });
            
            // ä»Šæ—¥çº¿ä¹Ÿéœ€è¦æ­£ç¡®é«˜åº¦
            if (todayUTC >= minDate && todayUTC <= maxDate) {
                const todayLine = ganttRows.querySelector('.gantt-today-line');
                if (todayLine) {
                    todayLine.style.height = `${visibleRowsHeight}px`;
                }
            }
        }
        
        // æ·»åŠ SVGç½‘æ ¼å¢å¼ºï¼ˆå¯é€‰ï¼‰
        addSVGGrid(ganttRows, (diffDays(minDate, maxDate) + 1) * dayWidth, displayRowIndex * 50);
        
        // ç§»é™¤ç”¨æˆ·é€‰æ‹©å™¨
        const userSelector = document.querySelector('.user-selector');
        if (userSelector) {
            userSelector.remove();
        }
    }
    
    // æ·»åŠ SVGç½‘æ ¼å¢å¼º
    function addSVGGrid(container, width, height) {
        // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨SVGç½‘æ ¼
        const existingSvg = container.querySelector('.grid-svg');
        if (existingSvg) {
            existingSvg.remove();
        }
        
        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.setAttribute("class", "grid-svg");
        svg.setAttribute("width", width);
        svg.setAttribute("height", height);
        svg.style.position = "absolute";
        svg.style.top = "0";
        svg.style.left = "0";
        svg.style.pointerEvents = "none";
        svg.style.zIndex = "0";
        
        // åˆ›å»ºå‚ç›´ç½‘æ ¼çº¿
        for (let x = 0; x <= width; x += dayWidth) {
            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute("x1", x);
            line.setAttribute("y1", 0);
            line.setAttribute("x2", x);
            line.setAttribute("y2", height);
            line.setAttribute("stroke", "#e0e0e0");
            line.setAttribute("stroke-width", "1");
            line.setAttribute("stroke-dasharray", "2,2");
            svg.appendChild(line);
        }
        
        // åˆ›å»ºæ°´å¹³ç½‘æ ¼çº¿
        for (let y = 0; y <= height; y += 50) { // 50pxä¸ºæ¯è¡Œé«˜åº¦
            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute("x1", 0);
            line.setAttribute("y1", y);
            line.setAttribute("x2", width);
            line.setAttribute("y2", y);
            line.setAttribute("stroke", "#f0f0f0");
            line.setAttribute("stroke-width", "1");
            svg.appendChild(line);
        }
        
        container.appendChild(svg);
    }
    
    // é¡µé¢åŠ è½½æ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œæ•°æ®åŠ è½½å’Œåˆå§‹åŒ–å‡½æ•°
    loadDataAndInitialize();
    
    // å¤„ç†é¡µé¢åˆ‡æ¢æ—¶ç§»é™¤ç”¨æˆ·é€‰æ‹©å™¨
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') {
            console.log('é¡µé¢å˜ä¸ºå¯è§ï¼Œé‡æ–°åŠ è½½æ•°æ®');
            // é‡æ–°è·å–æ•°æ®
            database.ref('taskCheckStatus').once('value', (snapshot) => {
                checkStatus = snapshot.val() || {};
                if (currentView === 'calendar') {
                    applyFilters();
                }
            });
        }
    });
});
</script>

</body>
</html>
