<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>课程表</title>
    <style>
        :root {
            --color-bg: #f8f9fa;
            --color-header-bg: #e9ecef;
            --color-grid-line: #dee2e6;
            --color-text: #212529;
            --color-text-light: #6c757d;
            --color-bar-default: #0d6efd;
            --color-today-line: #dc3545;
            --color-weekend: #f1f3f5;
            --bar-height: 30px;
            --row-height: 45px;
            --header-height: 60px;
            --sidebar-width: 200px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--color-bg);
            color: var(--color-text);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            padding: 10px 20px;
            background-color: #fff;
            border-bottom: 1px solid var(--color-grid-line);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .controls label {
            font-size: 0.9rem;
        }

        .controls select, .controls button {
            padding: 5px 10px;
            border: 1px solid var(--color-grid-line);
            border-radius: 4px;
            background-color: #fff;
            cursor: pointer;
        }

        .gantt-container {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }

        .gantt-sidebar {
            width: var(--sidebar-width);
            background-color: var(--color-header-bg);
            border-right: 1px solid var(--color-grid-line);
            overflow-y: auto;
            flex-shrink: 0;
        }

        .gantt-sidebar-header {
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border-bottom: 1px solid var(--color-grid-line);
            box-sizing: border-box;
        }

        .gantt-task-names {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .gantt-task-name {
            height: var(--row-height);
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 0 10px;
            border-bottom: 1px solid var(--color-grid-line);
            box-sizing: border-box;
            font-size: 0.9rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .gantt-task-name strong {
            font-size: 0.95rem;
        }
        .gantt-task-name small {
            font-size: 0.75rem;
            color: var(--color-text-light);
        }

        .gantt-grid-container {
            flex-grow: 1;
            overflow: auto;
        }

        .gantt-grid {
            position: relative;
            display: grid;
        }

        .gantt-header {
            display: grid;
            position: sticky;
            top: 0;
            z-index: 3;
            background-color: var(--color-header-bg);
            border-bottom: 1px solid var(--color-grid-line);
        }

        .gantt-month, .gantt-day {
            text-align: center;
            font-weight: bold;
            border-right: 1px solid var(--color-grid-line);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gantt-month {
            height: calc(var(--header-height) / 2);
            border-bottom: 1px solid var(--color-grid-line);
            font-size: 0.9rem;
        }

        .gantt-day {
            height: calc(var(--header-height) / 2);
            font-size: 0.75rem;
            color: var(--color-text-light);
        }
        .gantt-day.weekend {
            color: var(--color-today-line);
        }

        .gantt-row {
            height: var(--row-height);
            display: grid;
            border-bottom: 1px solid var(--color-grid-line);
            position: relative;
        }

        .gantt-cell {
            border-right: 1px solid var(--color-grid-line);
        }
        .gantt-cell.weekend {
            background-color: var(--color-weekend);
        }
        
        .gantt-bar {
            position: absolute;
            height: var(--bar-height);
            top: calc((var(--row-height) - var(--bar-height)) / 2);
            background-color: var(--color-bar-default);
            border-radius: 4px;
            color: white;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            padding: 0 10px;
            box-sizing: border-box;
            overflow: hidden;
            white-space: nowrap;
            cursor: pointer;
            transition: background-color 0.2s;
            z-index: 1;
        }
        .gantt-bar:hover {
            opacity: 0.8;
        }
        
        .gantt-bar-label {
            padding: 0 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .today-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: var(--color-today-line);
            z-index: 2;
        }
        
        #loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2rem;
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>课程表</h1>
        <div class="controls">
            <label for="viewMode">视图:</label>
            <select id="viewMode">
                <option value="day" selected>日</option>
                <option value="week">周</option>
            </select>
            <button id="goToToday">今天</button>
        </div>
    </div>

    <div class="gantt-container">
        <div class="gantt-sidebar">
            <div class="gantt-sidebar-header">教学主题</div>
            <ul id="gantt-task-names" class="gantt-task-names"></ul>
        </div>
        <div id="gantt-grid-container" class="gantt-grid-container">
            <div id="gantt-grid" class="gantt-grid">
                <div id="gantt-header" class="gantt-header"></div>
                <div id="gantt-rows" style="display: grid;"></div>
                <div id="today-line" class="today-line"></div>
            </div>
        </div>
    </div>
    
    <div id="loader">正在加载数据...</div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const ganttGrid = document.getElementById('gantt-grid');
            const ganttHeader = document.getElementById('gantt-header');
            const ganttRows = document.getElementById('gantt-rows');
            const taskNamesList = document.getElementById('gantt-task-names');
            const todayLine = document.getElementById('today-line');
            const gridContainer = document.getElementById('gantt-grid-container');
            const viewModeSelect = document.getElementById('viewMode');
            const goToTodayBtn = document.getElementById('goToToday');
            const loader = document.getElementById('loader');

            let tasks = [];
            let uniqueTopics = [];
            let startDate, endDate;
            let dayWidth = 50; // Default day width in pixels

            const colorPalette = [
                '#0d6efd', '#6f42c1', '#d63384', '#fd7e14', '#198754',
                '#20c997', '#0dcaf0', '#6c757d', '#ffc107', '#dc3545'
            ];
            let topicColorMap = {};

            function getDaysInMonth(year, month) {
                return new Date(year, month + 1, 0).getDate();
            }

            function getDayOfYear(date) {
                const start = new Date(date.getFullYear(), 0, 0);
                const diff = date - start;
                const oneDay = 1000 * 60 * 60 * 24;
                return Math.floor(diff / oneDay);
            }

            function dateDiffInDays(a, b) {
                const _MS_PER_DAY = 1000 * 60 * 60 * 24;
                const utc1 = Date.UTC(a.getFullYear(), a.getMonth(), a.getDate());
                const utc2 = Date.UTC(b.getFullYear(), b.getMonth(), b.getDate());
                return Math.floor((utc2 - utc1) / _MS_PER_DAY);
            }

            function render() {
                if (!tasks.length) {
                    loader.textContent = "没有课程数据。请检查 data.json 文件。";
                    return;
                }
                loader.style.display = 'none';
                
                // Calculate date range
                const allDates = tasks.flatMap(t => [new Date(t.sessionStart), new Date(t.sessionEnd)]);
                startDate = new Date(Math.min.apply(null, allDates));
                endDate = new Date(Math.max.apply(null, allDates));
                
                startDate.setDate(startDate.getDate() - 15);
                endDate.setDate(endDate.getDate() + 15);

                uniqueTopics = [...new Map(tasks.map(item => [item.topic, item])).values()];
                
                // Assign colors
                uniqueTopics.forEach((task, index) => {
                    topicColorMap[task.topic] = colorPalette[index % colorPalette.length];
                });

                renderGrid();
                scrollToToday();
            }

            function renderGrid() {
                ganttHeader.innerHTML = '';
                ganttRows.innerHTML = '';
                taskNamesList.innerHTML = '';
                
                const totalDays = dateDiffInDays(startDate, endDate) + 1;
                const viewMode = viewModeSelect.value;
                
                if (viewMode === 'week') {
                    dayWidth = 15;
                } else {
                    dayWidth = 50;
                }

                ganttGrid.style.width = `${totalDays * dayWidth}px`;
                ganttHeader.style.gridTemplateColumns = `repeat(${totalDays}, ${dayWidth}px)`;
                ganttRows.style.gridTemplateColumns = `repeat(${totalDays}, ${dayWidth}px)`;
                ganttRows.style.gridTemplateRows = `repeat(${uniqueTopics.length}, var(--row-height))`;

                // Render Header
                let months = {};
                for (let i = 0; i < totalDays; i++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(currentDate.getDate() + i);
                    const monthKey = `${currentDate.getFullYear()}-${currentDate.getMonth()}`;
                    if (!months[monthKey]) {
                        months[monthKey] = { count: 0, name: `${currentDate.getFullYear()}年 ${currentDate.getMonth() + 1}月` };
                    }
                    months[monthKey].count++;

                    const dayEl = document.createElement('div');
                    dayEl.classList.add('gantt-day');
                    dayEl.textContent = currentDate.getDate();
                    const dayOfWeek = currentDate.getDay();
                    if (dayOfWeek === 0 || dayOfWeek === 6) {
                        dayEl.classList.add('weekend');
                    }
                    ganttHeader.appendChild(dayEl);
                }

                Object.values(months).forEach(month => {
                    const monthEl = document.createElement('div');
                    monthEl.classList.add('gantt-month');
                    monthEl.textContent = month.name;
                    monthEl.style.gridColumn = `span ${month.count}`;
                    ganttHeader.insertBefore(monthEl, ganttHeader.firstChild);
                });

                // Render Rows and Tasks
                uniqueTopics.forEach((topicData, index) => {
                    // Render task name in sidebar
                    const taskNameEl = document.createElement('li');
                    taskNameEl.classList.add('gantt-task-name');
                    taskNameEl.innerHTML = `<strong>${topicData.topic}</strong><small>${topicData.teacher}</small>`;
                    taskNamesList.appendChild(taskNameEl);

                    // Render grid row
                    const rowEl = document.createElement('div');
                    rowEl.classList.add('gantt-row');
                    rowEl.style.gridTemplateColumns = `repeat(${totalDays}, ${dayWidth}px)`;
                    
                    for (let i = 0; i < totalDays; i++) {
                        const cell = document.createElement('div');
                        cell.classList.add('gantt-cell');
                        const currentDate = new Date(startDate);
                        currentDate.setDate(currentDate.getDate() + i);
                        const dayOfWeek = currentDate.getDay();
                        if (dayOfWeek === 0 || dayOfWeek === 6) {
                            cell.classList.add('weekend');
                        }
                        rowEl.appendChild(cell);
                    }
                    ganttRows.appendChild(rowEl);
                    
                    // Render bars for this topic
                    const topicTasks = tasks.filter(t => t.topic === topicData.topic);
                    topicTasks.forEach(task => {
                        const taskStart = new Date(task.sessionStart);
                        const taskEnd = new Date(task.sessionEnd);

                        const startOffset = dateDiffInDays(startDate, taskStart);
                        const duration = dateDiffInDays(taskStart, taskEnd) + 1;

                        if (startOffset >= 0 && startOffset < totalDays) {
                            const bar = document.createElement('div');
                            bar.classList.add('gantt-bar');
                            bar.style.left = `${startOffset * dayWidth}px`;
                            bar.style.width = `${duration * dayWidth - 2}px`; // -2 for padding
                            bar.style.gridRow = `${index + 1}`;
                            bar.style.backgroundColor = topicColorMap[task.topic];
                            
                            const label = document.createElement('span');
                            label.classList.add('gantt-bar-label');
                            label.textContent = `${task.topic} - ${task.session}`;
                            bar.title = `${task.topic} - ${task.session}\n教师: ${task.teacher}\n日期: ${task.sessionStart} 到 ${task.sessionEnd}`;
                            bar.appendChild(label);
                            
                            ganttGrid.appendChild(bar);
                        }
                    });
                });

                // Render Today Line
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                if (today >= startDate && today <= endDate) {
                    const todayOffset = dateDiffInDays(startDate, today);
                    todayLine.style.left = `${todayOffset * dayWidth}px`;
                    todayLine.style.display = 'block';
                } else {
                    todayLine.style.display = 'none';
                }
            }

            function scrollToToday() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                if (today >= startDate && today <= endDate) {
                    const todayOffset = dateDiffInDays(startDate, today);
                    const scrollPosition = (todayOffset * dayWidth) - (gridContainer.clientWidth / 2) + (dayWidth / 2);
                    gridContainer.scrollLeft = scrollPosition;
                }
            }

            async function loadData() {
                try {
                    const response = await fetch('data.json');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    tasks = await response.json();
                    render();
                } catch (error) {
                    console.error("无法加载课程数据:", error);
                    loader.textContent = "加载数据失败。请检查网络连接或联系管理员。";
                }
            }

            viewModeSelect.addEventListener('change', renderGrid);
            goToTodayBtn.addEventListener('click', scrollToToday);

            // Sync scrolling between sidebar and grid
            gridContainer.addEventListener('scroll', () => {
                taskNamesList.parentElement.scrollTop = gridContainer.scrollTop;
            });
            taskNamesList.parentElement.addEventListener('scroll', () => {
                gridContainer.scrollTop = taskNamesList.parentElement.scrollTop;
            });


            loadData();
        });
    </script>
</body>
</html>
